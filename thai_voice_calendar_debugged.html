<!DOCTYPE html>
<html>
<head>
    <title>Thai Voice Calendar Assistant (Debugged)</title>
    <meta charset="utf-8">
    <style>
        body {
            font-family: 'Sarabun', Arial, sans-serif;
            max-width: 1000px;
            margin: 0 auto;
            padding: 20px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            min-height: 100vh;
        }
        .container {
            background: rgba(255,255,255,0.1);
            padding: 30px;
            border-radius: 15px;
            backdrop-filter: blur(10px);
            box-shadow: 0 8px 32px 0 rgba(31, 38, 135, 0.37);
        }
        .calendar-section {
            background: rgba(74, 144, 226, 0.3);
            padding: 20px;
            border-radius: 10px;
            margin: 20px 0;
            border-left: 5px solid #4a90e2;
        }
        .microbit-section {
            background: rgba(255,255,255,0.2);
            padding: 20px;
            border-radius: 10px;
            margin: 20px 0;
        }
        h1 {
            text-align: center;
            margin-bottom: 30px;
            font-size: 2.5em;
        }
        button {
            background: linear-gradient(45deg, #ff6b6b, #ee5a24);
            color: white;
            border: none;
            padding: 15px 30px;
            margin: 10px;
            border-radius: 25px;
            font-size: 18px;
            cursor: pointer;
            transition: all 0.3s ease;
            min-width: 150px;
        }
        .calendar-btn {
            background: linear-gradient(45deg, #4a90e2, #357abd);
        }
        .connect-btn {
            background: linear-gradient(45deg, #4ecdc4, #44a08d);
        }
        .status-connected {
            background: linear-gradient(45deg, #56ab2f, #a8e6cf);
        }
        button:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(0,0,0,0.3);
        }
        button:disabled {
            background: #666;
            cursor: not-allowed;
            transform: none;
        }
        #result {
            background: rgba(255,255,255,0.9);
            color: #333;
            padding: 20px;
            margin: 20px 0;
            border-radius: 10px;
            min-height: 80px;
            font-size: 20px;
            line-height: 1.5;
        }
        .parsed-command {
            background: rgba(74, 144, 226, 0.2);
            color: white;
            padding: 15px;
            margin: 10px 0;
            border-radius: 8px;
            border-left: 4px solid #4a90e2;
        }
        #status, #microbitStatus, #calendarStatus {
            text-align: center;
            font-size: 18px;
            margin: 15px 0;
            padding: 10px;
            background: rgba(255,255,255,0.2);
            border-radius: 10px;
        }
        .controls {
            text-align: center;
            margin: 20px 0;
        }
        .instruction {
            background: rgba(255,255,255,0.1);
            padding: 15px;
            border-radius: 10px;
            margin: 15px 0;
            font-size: 16px;
        }
        .log {
            background: rgba(0,0,0,0.3);
            color: #00ff00;
            padding: 15px;
            border-radius: 10px;
            font-family: 'Courier New', monospace;
            font-size: 14px;
            max-height: 200px;
            overflow-y: auto;
            margin-top: 20px;
        }
        .command-examples {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 15px;
            margin: 20px 0;
        }
        .example-card {
            background: rgba(255,255,255,0.1);
            padding: 15px;
            border-radius: 8px;
            border-left: 3px solid #4a90e2;
        }
        .auth-setup {
            background: rgba(255, 193, 7, 0.2);
            border: 2px solid #ffc107;
            padding: 20px;
            border-radius: 10px;
            margin: 20px 0;
        }
        .warning {
            background: rgba(220, 53, 69, 0.2);
            border: 2px solid #dc3545;
            padding: 15px;
            border-radius: 8px;
            margin: 10px 0;
        }
        .success {
            background: rgba(40, 167, 69, 0.2);
            border: 2px solid #28a745;
            padding: 15px;
            border-radius: 8px;
            margin: 10px 0;
        }
        .error {
            background: rgba(220, 53, 69, 0.2);
            border: 2px solid #dc3545;
            padding: 15px;
            border-radius: 8px;
            margin: 10px 0;
        }
        .debug-section {
            background: rgba(255, 255, 255, 0.1);
            border: 2px solid #00ff00;
            padding: 15px;
            border-radius: 10px;
            margin: 20px 0;
            font-family: 'Courier New', monospace;
            font-size: 14px;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>üìÖ Thai Voice Calendar Assistant (Debugged)</h1>
        
        <!-- Debug Information -->
        <div class="debug-section">
            <h4>üîç Debug Information</h4>
            <div id="debugInfo">Checking browser compatibility...</div>
        </div>
        
        <!-- Google Calendar Setup -->
        <div class="calendar-section">
            <h3>üìÖ Google Calendar Setup</h3>
            
            <div class="auth-setup">
                <h4>‚ö†Ô∏è ‡∏Å‡πà‡∏≠‡∏ô‡πÄ‡∏£‡∏¥‡πà‡∏°‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô - ‡∏ï‡πâ‡∏≠‡∏á‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤ Google API</h4>
                <p>1. ‡πÑ‡∏õ‡∏ó‡∏µ‡πà <a href="https://console.cloud.google.com/" target="_blank" style="color: #ffc107;">Google Cloud Console</a></p>
                <p>2. ‡∏™‡∏£‡πâ‡∏≤‡∏á‡πÇ‡∏õ‡∏£‡πÄ‡∏à‡∏Ñ‡πÉ‡∏´‡∏°‡πà‡∏´‡∏£‡∏∑‡∏≠‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÇ‡∏õ‡∏£‡πÄ‡∏à‡∏Ñ‡∏ó‡∏µ‡πà‡∏°‡∏µ‡∏≠‡∏¢‡∏π‡πà</p>
                <p>3. ‡πÄ‡∏õ‡∏¥‡∏î‡πÉ‡∏ä‡πâ Google Calendar API</p>
                <p>4. ‡∏™‡∏£‡πâ‡∏≤‡∏á OAuth 2.0 Credentials (Web application)</p>
                <p>5. ‡πÄ‡∏û‡∏¥‡πà‡∏° <strong>http://localhost:8000</strong> ‡∏´‡∏£‡∏∑‡∏≠ domain ‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì‡πÉ‡∏ô Authorized origins</p>
                <p>6. ‡∏ô‡∏≥ CLIENT_ID ‡∏°‡∏≤‡πÉ‡∏™‡πà‡πÉ‡∏ô‡πÇ‡∏Ñ‡πâ‡∏î‡∏î‡πâ‡∏≤‡∏ô‡∏•‡πà‡∏≤‡∏á</p>
            </div>
            
            <div class="controls">
                <input type="text" id="clientIdInput" placeholder="‡πÉ‡∏™‡πà Google OAuth Client ID ‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì" 
                       style="width: 60%; padding: 10px; margin: 10px; border-radius: 5px; border: none;">
                <button id="saveClientId" class="calendar-btn">üíæ ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å Client ID</button>
            </div>
            
            <div class="controls">
                <button id="authBtn" class="calendar-btn" disabled>üîê ‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö Google</button>
                <button id="signoutBtn" class="calendar-btn" disabled>üö™ ‡∏≠‡∏≠‡∏Å‡∏à‡∏≤‡∏Å‡∏£‡∏∞‡∏ö‡∏ö</button>
                <button id="testApiBtn" class="calendar-btn" disabled>üîß ‡∏ó‡∏î‡∏™‡∏≠‡∏ö API</button>
            </div>
            <div id="calendarStatus">‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤ Google API</div>
            
            <div class="instruction">
                <strong>‡∏ï‡∏±‡∏ß‡∏≠‡∏¢‡πà‡∏≤‡∏á‡∏Ñ‡∏≥‡∏™‡∏±‡πà‡∏á:</strong>
                <div class="command-examples">
                    <div class="example-card">
                        <strong>"‡∏ß‡∏±‡∏ô‡∏à‡∏±‡∏ô‡∏ó‡∏£‡πå‡∏°‡∏µ‡∏ô‡∏±‡∏î‡∏™‡∏≠‡∏ô‡∏û‡∏¥‡πÄ‡∏®‡∏© ‡πÄ‡∏ß‡∏•‡∏≤ 19.30 ‡∏ô."</strong><br>
                        ‚Üí ‡∏™‡∏£‡πâ‡∏≤‡∏á event ‡∏ß‡∏±‡∏ô‡∏à‡∏±‡∏ô‡∏ó‡∏£‡πå‡∏´‡∏ô‡πâ‡∏≤ ‡πÄ‡∏ß‡∏•‡∏≤ 19:30
                    </div>
                    <div class="example-card">
                        <strong>"‡∏ß‡∏±‡∏ô‡∏≠‡∏±‡∏á‡∏Ñ‡∏≤‡∏£‡∏ó‡∏µ‡πà 25 ‡∏õ‡∏£‡∏∞‡∏ä‡∏∏‡∏°‡∏ó‡∏µ‡∏° ‡πÄ‡∏ß‡∏•‡∏≤ 14.00 ‡∏ô."</strong><br>
                        ‚Üí ‡∏™‡∏£‡πâ‡∏≤‡∏á event ‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà 25 ‡πÄ‡∏ß‡∏•‡∏≤ 14:00
                    </div>
                    <div class="example-card">
                        <strong>"‡∏û‡∏£‡∏∏‡πà‡∏á‡∏ô‡∏µ‡πâ‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡∏û‡∏¥‡πÄ‡∏®‡∏© ‡∏ï‡∏±‡πâ‡∏á‡πÅ‡∏ï‡πà 9 ‡πÇ‡∏°‡∏á‡πÄ‡∏ä‡πâ‡∏≤ ‡∏ñ‡∏∂‡∏á 12 ‡πÇ‡∏°‡∏á"</strong><br>
                        ‚Üí ‡∏™‡∏£‡πâ‡∏≤‡∏á event ‡∏û‡∏£‡∏∏‡πà‡∏á‡∏ô‡∏µ‡πâ 09:00-12:00
                    </div>
                    <div class="example-card">
                        <strong>"‡∏•‡∏ö‡∏ô‡∏±‡∏î‡∏´‡∏°‡∏≤‡∏¢‡∏ß‡∏±‡∏ô‡πÄ‡∏™‡∏≤‡∏£‡πå"</strong><br>
                        ‚Üí ‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡πÅ‡∏•‡∏∞‡∏•‡∏ö events ‡∏ß‡∏±‡∏ô‡πÄ‡∏™‡∏≤‡∏£‡πå
                    </div>
                </div>
            </div>
        </div>

        <!-- micro:bit Connection -->
        <div class="microbit-section">
            <h3>üìü ‡∏Å‡∏≤‡∏£‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠ micro:bit</h3>
            <div class="controls">
                <button id="connectBtn" class="connect-btn">üîå ‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠ micro:bit</button>
                <button id="disconnectBtn" class="connect-btn" disabled>‚èπ ‡∏ï‡∏±‡∏î‡∏Å‡∏≤‡∏£‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠</button>
            </div>
            <div id="microbitStatus">‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠ micro:bit</div>
            
            <div class="instruction">
                üìã <strong>‡∏ß‡∏¥‡∏ò‡∏µ‡πÉ‡∏ä‡πâ:</strong><br>
                ‚Ä¢ <strong>‡∏õ‡∏∏‡πà‡∏° A</strong> ‡∏ö‡∏ô micro:bit = ‡∏™‡∏±‡πà‡∏á‡∏á‡∏≤‡∏ô Calendar<br>
                ‚Ä¢ <strong>‡∏õ‡∏∏‡πà‡∏° B</strong> ‡∏ö‡∏ô micro:bit = ‡∏Ñ‡∏≥‡∏™‡∏±‡πà‡∏á‡∏ó‡∏±‡πà‡∏ß‡πÑ‡∏õ<br>
                ‚Ä¢ <strong>A+B</strong> = ‡πÅ‡∏™‡∏î‡∏á‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î
            </div>
        </div>

        <!-- Speech Recognition -->
        <div class="controls">
            <button id="startBtn">üéôÔ∏è ‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ü‡∏±‡∏á</button>
            <button id="stopBtn" disabled>‚èπÔ∏è ‡∏´‡∏¢‡∏∏‡∏î‡∏ü‡∏±‡∏á</button>
            <button id="executeBtn" disabled class="calendar-btn">üöÄ ‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏Å‡∏≤‡∏£</button>
            <button id="clearBtn">üóëÔ∏è ‡∏•‡πâ‡∏≤‡∏á‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°</button>
        </div>
        
        <div id="status">‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤ Google API ‡πÅ‡∏•‡∏∞‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠ micro:bit ‡∏Å‡πà‡∏≠‡∏ô</div>
        
        <div id="result">‡∏Ñ‡∏≥‡∏™‡∏±‡πà‡∏á‡∏ó‡∏µ‡πà‡∏£‡∏π‡πâ‡∏à‡∏≥‡πÑ‡∏î‡πâ‡∏à‡∏∞‡πÅ‡∏™‡∏î‡∏á‡∏ó‡∏µ‡πà‡∏ô‡∏µ‡πà...</div>
        
        <!-- Parsed Command Display -->
        <div id="parsedCommand" class="parsed-command" style="display: none;">
            <h4>üìã ‡∏Ñ‡∏≥‡∏™‡∏±‡πà‡∏á‡∏ó‡∏µ‡πà‡πÅ‡∏õ‡∏•‡πÅ‡∏•‡πâ‡∏ß:</h4>
            <div id="commandDetails"></div>
        </div>

        <div class="instruction">
            ‚å®Ô∏è <strong>‡∏Ñ‡∏µ‡∏¢‡πå‡∏ö‡∏≠‡∏£‡πå‡∏î:</strong> Space = ‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ü‡∏±‡∏á | Escape = ‡∏´‡∏¢‡∏∏‡∏î‡∏ü‡∏±‡∏á | Enter = ‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏Å‡∏≤‡∏£
        </div>

        <div id="log" class="log">
            <div>üöÄ ‡∏£‡∏∞‡∏ö‡∏ö‡∏û‡∏£‡πâ‡∏≠‡∏°‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô...</div>
        </div>
    </div>

    <script>
        // ‡∏ï‡∏±‡∏ß‡πÅ‡∏õ‡∏£‡∏ï‡πà‡∏≤‡∏á‡πÜ
        let port = null;
        let reader = null;
        let writer = null;
        let recognition = null;
        let isListening = false;
        let isConnected = false;
        let currentText = '';
        let currentCommand = null;
        let commandMode = 'GENERAL';
        
        // Google API
        let isGoogleAuthorized = false;
        let isGoogleAPILoaded = false;
        let CLIENT_ID = '';
        const DISCOVERY_DOC = 'https://www.googleapis.com/discovery/v1/apis/calendar/v3/rest';
        const SCOPES = 'https://www.googleapis.com/auth/calendar';

        // Elements
        const clientIdInput = document.getElementById('clientIdInput');
        const saveClientIdBtn = document.getElementById('saveClientId');
        const connectBtn = document.getElementById('connectBtn');
        const disconnectBtn = document.getElementById('disconnectBtn');
        const authBtn = document.getElementById('authBtn');
        const signoutBtn = document.getElementById('signoutBtn');
        const testApiBtn = document.getElementById('testApiBtn');
        const startBtn = document.getElementById('startBtn');
        const stopBtn = document.getElementById('stopBtn');
        const executeBtn = document.getElementById('executeBtn');
        const clearBtn = document.getElementById('clearBtn');
        const result = document.getElementById('result');
        const status = document.getElementById('status');
        const microbitStatus = document.getElementById('microbitStatus');
        const calendarStatus = document.getElementById('calendarStatus');
        const log = document.getElementById('log');
        const parsedCommand = document.getElementById('parsedCommand');
        const commandDetails = document.getElementById('commandDetails');
        const debugInfo = document.getElementById('debugInfo');

        // ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô log
        function addLog(message) {
            const time = new Date().toLocaleTimeString('th-TH');
            log.innerHTML += `<div>[${time}] ${message}</div>`;
            log.scrollTop = log.scrollHeight;
        }

        // ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô Debug Info
        function updateDebugInfo() {
            const info = [];
            info.push(`Browser: ${navigator.userAgent.split(' ')[navigator.userAgent.split(' ').length - 1]}`);
            info.push(`HTTPS: ${location.protocol === 'https:' ? '‚úÖ' : '‚ùå'}`);
            info.push(`Web Serial: ${'serial' in navigator ? '‚úÖ' : '‚ùå'}`);
            info.push(`Speech Recognition: ${('webkitSpeechRecognition' in window || 'SpeechRecognition' in window) ? '‚úÖ' : '‚ùå'}`);
            info.push(`Google APIs Script: ${typeof gapi !== 'undefined' ? '‚úÖ' : '‚ùå'}`);
            info.push(`Client ID Set: ${CLIENT_ID ? '‚úÖ' : '‚ùå'}`);
            info.push(`Google API Loaded: ${isGoogleAPILoaded ? '‚úÖ' : '‚ùå'}`);
            info.push(`Google Authorized: ${isGoogleAuthorized ? '‚úÖ' : '‚ùå'}`);
            info.push(`micro:bit Connected: ${isConnected ? '‚úÖ' : '‚ùå'}`);
            
            debugInfo.innerHTML = info.join('<br>');
        }

        // ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å Client ID
        function saveClientId() {
            const clientId = clientIdInput.value.trim();
            if (!clientId) {
                addLog('‚ö†Ô∏è ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÉ‡∏™‡πà Google OAuth Client ID');
                calendarStatus.innerHTML = '‚ö†Ô∏è ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÉ‡∏™‡πà Client ID';
                calendarStatus.className = 'warning';
                return;
            }
            
            // ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏£‡∏π‡∏õ‡πÅ‡∏ö‡∏ö Client ID
            if (!clientId.includes('.apps.googleusercontent.com')) {
                addLog('‚ö†Ô∏è Client ID ‡∏î‡∏π‡πÄ‡∏´‡∏°‡∏∑‡∏≠‡∏ô‡πÑ‡∏°‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á - ‡∏Ñ‡∏ß‡∏£‡∏•‡∏á‡∏ó‡πâ‡∏≤‡∏¢‡∏î‡πâ‡∏ß‡∏¢ .apps.googleusercontent.com');
                calendarStatus.innerHTML = '‚ö†Ô∏è ‡∏£‡∏π‡∏õ‡πÅ‡∏ö‡∏ö Client ID ‡πÑ‡∏°‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á';
                calendarStatus.className = 'warning';
            }
            
            CLIENT_ID = clientId;
            authBtn.disabled = false;
            addLog(`‚úÖ ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å Client ID ‡πÅ‡∏•‡πâ‡∏ß: ${CLIENT_ID.substring(0, 20)}...`);
            calendarStatus.innerHTML = '‡∏û‡∏£‡πâ‡∏≠‡∏°‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö Google';
            calendarStatus.className = '';
            updateDebugInfo();
            
            // ‡πÇ‡∏´‡∏•‡∏î Google API
            initializeGoogleAPI();
        }

        // Google API Initialization - ‡∏õ‡∏£‡∏±‡∏ö‡∏õ‡∏£‡∏∏‡∏á‡∏Å‡∏≤‡∏£‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î
        async function initializeGoogleAPI() {
            if (!CLIENT_ID) {
                addLog('‚ö†Ô∏è ‡∏ï‡πâ‡∏≠‡∏á‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤ Client ID ‡∏Å‡πà‡∏≠‡∏ô');
                return;
            }

            try {
                addLog('üîß ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î Google Calendar API...');
                
                // ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏ß‡πà‡∏≤ gapi ‡πÇ‡∏´‡∏•‡∏î‡πÅ‡∏•‡πâ‡∏ß‡∏´‡∏£‡∏∑‡∏≠‡∏¢‡∏±‡∏á
                if (typeof gapi === 'undefined') {
                    throw new Error('Google APIs script ‡πÑ‡∏°‡πà‡πÇ‡∏´‡∏•‡∏î - ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏Å‡∏≤‡∏£‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠‡∏≠‡∏¥‡∏ô‡πÄ‡∏ó‡∏≠‡∏£‡πå‡πÄ‡∏ô‡πá‡∏ï');
                }
                
                // ‡∏£‡∏≠ Google APIs ‡πÇ‡∏´‡∏•‡∏î‡πÄ‡∏™‡∏£‡πá‡∏à ‡∏û‡∏£‡πâ‡∏≠‡∏° timeout
                await new Promise((resolve, reject) => {
                    const timeout = setTimeout(() => {
                        reject(new Error('Google APIs ‡πÇ‡∏´‡∏•‡∏î‡∏ä‡πâ‡∏≤‡πÄ‡∏Å‡∏¥‡∏ô‡πÑ‡∏õ - ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏Å‡∏≤‡∏£‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠'));
                    }, 15000); // 15 ‡∏ß‡∏¥‡∏ô‡∏≤‡∏ó‡∏µ timeout
                    
                    gapi.load('client:auth2', {
                        callback: () => {
                            clearTimeout(timeout);
                            resolve();
                        },
                        onerror: (error) => {
                            clearTimeout(timeout);
                            reject(new Error(`Google APIs ‡πÇ‡∏´‡∏•‡∏î‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à: ${error}`));
                        }
                    });
                });

                // ‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤ Google Client
                await gapi.client.init({
                    clientId: CLIENT_ID,
                    discoveryDocs: [DISCOVERY_DOC],
                    scope: SCOPES
                });
                
                const authInstance = gapi.auth2.getAuthInstance();
                if (!authInstance) {
                    throw new Error('‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏™‡∏£‡πâ‡∏≤‡∏á Auth Instance ‡πÑ‡∏î‡πâ - ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö Client ID');
                }
                
                isGoogleAuthorized = authInstance.isSignedIn.get();
                isGoogleAPILoaded = true;
                
                // Listen for sign-in state changes
                authInstance.isSignedIn.listen(updateGoogleStatus);
                
                updateGoogleStatus();
                updateDebugInfo();
                testApiBtn.disabled = false;
                
                addLog('‚úÖ Google Calendar API ‡πÇ‡∏´‡∏•‡∏î‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à');
                
            } catch (error) {
                addLog(`‚ùå ‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÇ‡∏´‡∏•‡∏î Google API: ${error.message || error.details || error}`);
                calendarStatus.innerHTML = '‚ùå ‡πÇ‡∏´‡∏•‡∏î Google API ‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à - ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö Client ID';
                calendarStatus.className = 'error';
                
                // ‡πÅ‡∏™‡∏î‡∏á‡∏Ç‡πâ‡∏≠‡πÅ‡∏ô‡∏∞‡∏ô‡∏≥‡∏Å‡∏≤‡∏£‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç
                if (error.message && error.message.includes('invalid_client')) {
                    addLog('üí° Client ID ‡πÑ‡∏°‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á - ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡πÉ‡∏ô Google Cloud Console');
                } else if (error.message && error.message.includes('origin_mismatch')) {
                    addLog('üí° Domain ‡πÑ‡∏°‡πà‡∏ï‡∏£‡∏á‡∏Å‡∏±‡∏ô - ‡πÄ‡∏û‡∏¥‡πà‡∏° domain ‡∏ô‡∏µ‡πâ‡πÉ‡∏ô Authorized origins');
                } else if (error.message && error.message.includes('‡πÇ‡∏´‡∏•‡∏î‡∏ä‡πâ‡∏≤')) {
                    addLog('üí° ‡∏•‡∏≠‡∏á‡∏£‡∏µ‡πÄ‡∏ü‡∏£‡∏ä‡∏´‡∏ô‡πâ‡∏≤‡πÄ‡∏ß‡πá‡∏ö‡πÅ‡∏•‡πâ‡∏ß‡∏•‡∏≠‡∏á‡πÉ‡∏´‡∏°‡πà');
                } else if (error.message && error.message.includes('script ‡πÑ‡∏°‡πà‡πÇ‡∏´‡∏•‡∏î')) {
                    addLog('üí° ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏Å‡∏≤‡∏£‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠‡∏≠‡∏¥‡∏ô‡πÄ‡∏ó‡∏≠‡∏£‡πå‡πÄ‡∏ô‡πá‡∏ï');
                }
                
                updateDebugInfo();
            }
        }

        // ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ó‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞ Google
        function updateGoogleStatus() {
            if (!isGoogleAPILoaded) return;
            
            try {
                const authInstance = gapi.auth2.getAuthInstance();
                isGoogleAuthorized = authInstance.isSignedIn.get();
                
                if (isGoogleAuthorized) {
                    const user = authInstance.currentUser.get();
                    const profile = user.getBasicProfile();
                    
                    calendarStatus.innerHTML = `‚úÖ ‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠ Google Calendar ‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à<br>‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ: ${profile.getName()}`;
                    calendarStatus.className = 'success';
                    authBtn.disabled = true;
                    signoutBtn.disabled = false;
                    addLog(`‚úÖ ‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö Google ‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à: ${profile.getName()}`);
                } else {
                    calendarStatus.innerHTML = '‚ùå ‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö Google';
                    calendarStatus.className = '';
                    authBtn.disabled = false;
                    signoutBtn.disabled = true;
                    executeBtn.disabled = true;
                }
                updateStatus();
                updateDebugInfo();
            } catch (error) {
                addLog(`‚ùå ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ó‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞ Google ‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à: ${error.message}`);
                updateDebugInfo();
            }
        }

        // ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö Google
        async function signIn() {
            if (!isGoogleAPILoaded) {
                addLog('‚ùå Google API ‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏û‡∏£‡πâ‡∏≠‡∏°');
                return;
            }

            try {
                addLog('üîê ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö Google...');
                const authInstance = gapi.auth2.getAuthInstance();
                
                await authInstance.signIn({
                    prompt: 'select_account'
                });
                
            } catch (error) {
                addLog(`‚ùå ‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à: ${error.error || error.message}`);
                
                if (error.error === 'popup_blocked_by_browser') {
                    addLog('üí° ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏≠‡∏ô‡∏∏‡∏ç‡∏≤‡∏ï popup ‡πÉ‡∏ô‡πÄ‡∏ö‡∏£‡∏≤‡∏ß‡πå‡πÄ‡∏ã‡∏≠‡∏£‡πå');
                } else if (error.error === 'access_denied') {
                    addLog('üí° ‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡∏õ‡∏è‡∏¥‡πÄ‡∏™‡∏ò‡∏Å‡∏≤‡∏£‡πÄ‡∏Ç‡πâ‡∏≤‡∏ñ‡∏∂‡∏á');
                } else if (error.error === 'invalid_client') {
                    addLog('üí° Client ID ‡πÑ‡∏°‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á');
                }
            }
        }

        // ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏≠‡∏≠‡∏Å‡∏à‡∏≤‡∏Å‡∏£‡∏∞‡∏ö‡∏ö Google
        async function signOut() {
            try {
                const authInstance = gapi.auth2.getAuthInstance();
                await authInstance.signOut();
                addLog('üö™ ‡∏≠‡∏≠‡∏Å‡∏à‡∏≤‡∏Å‡∏£‡∏∞‡∏ö‡∏ö Google ‡πÅ‡∏•‡πâ‡∏ß');
            } catch (error) {
                addLog(`‚ùå ‡∏≠‡∏≠‡∏Å‡∏à‡∏≤‡∏Å‡∏£‡∏∞‡∏ö‡∏ö‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à: ${error.message}`);
            }
        }

        // ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏ó‡∏î‡∏™‡∏≠‡∏ö API
        async function testAPI() {
            if (!isGoogleAuthorized) {
                addLog('‚ùå ‡∏ï‡πâ‡∏≠‡∏á‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö Google ‡∏Å‡πà‡∏≠‡∏ô');
                return;
            }

            try {
                addLog('üß™ ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ó‡∏î‡∏™‡∏≠‡∏ö Google Calendar API...');
                
                const response = await gapi.client.calendar.calendarList.list();
                const calendars = response.result.items || [];
                
                addLog(`‚úÖ ‡∏ó‡∏î‡∏™‡∏≠‡∏ö API ‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à - ‡∏û‡∏ö ${calendars.length} ‡∏õ‡∏è‡∏¥‡∏ó‡∏¥‡∏ô`);
                calendars.forEach((calendar, index) => {
                    if (index < 3) { // ‡πÅ‡∏™‡∏î‡∏á‡πÅ‡∏Ñ‡πà 3 ‡∏≠‡∏±‡∏ô‡πÅ‡∏£‡∏Å
                        addLog(`üìÖ ‡∏õ‡∏è‡∏¥‡∏ó‡∏¥‡∏ô: ${calendar.summary}`);
                    }
                });
                
            } catch (error) {
                addLog(`‚ùå ‡∏ó‡∏î‡∏™‡∏≠‡∏ö API ‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à: ${error.message}`);
                
                if (error.status === 403) {
                    addLog('üí° ‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡πå‡πÄ‡∏Ç‡πâ‡∏≤‡∏ñ‡∏∂‡∏á - ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö Scope ‡πÅ‡∏•‡∏∞ API Enable');
                } else if (error.status === 401) {
                    addLog('üí° ‡∏Å‡∏≤‡∏£‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏ï‡∏±‡∏ß‡∏ï‡∏ô‡πÑ‡∏°‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á - ‡∏•‡∏≠‡∏á‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö‡πÉ‡∏´‡∏°‡πà');
                }
            }
        }

        // ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡πÅ‡∏õ‡∏•‡∏á‡∏Ñ‡∏≥‡∏™‡∏±‡πà‡∏á‡∏†‡∏≤‡∏©‡∏≤‡πÑ‡∏ó‡∏¢ - ‡∏õ‡∏£‡∏±‡∏ö‡∏õ‡∏£‡∏∏‡∏á‡∏Å‡∏≤‡∏£‡∏à‡∏±‡∏ö pattern
        function parseThaiCommand(text) {
            const command = {
                type: 'unknown',
                title: '',
                date: null,
                startTime: null,
                endTime: null,
                description: text
            };

            // ‡πÅ‡∏õ‡∏•‡∏á‡∏ß‡∏±‡∏ô‡πÉ‡∏ô‡∏™‡∏±‡∏õ‡∏î‡∏≤‡∏´‡πå
            const dayMap = {
                '‡∏ß‡∏±‡∏ô‡∏à‡∏±‡∏ô‡∏ó‡∏£‡πå': 1, '‡∏à‡∏±‡∏ô‡∏ó‡∏£‡πå': 1, '‡∏ß‡∏±‡∏ô‡∏à': 1,
                '‡∏ß‡∏±‡∏ô‡∏≠‡∏±‡∏á‡∏Ñ‡∏≤‡∏£': 2, '‡∏≠‡∏±‡∏á‡∏Ñ‡∏≤‡∏£': 2, '‡∏ß‡∏±‡∏ô‡∏≠': 2,
                '‡∏ß‡∏±‡∏ô‡∏û‡∏∏‡∏ò': 3, '‡∏û‡∏∏‡∏ò': 3,
                '‡∏ß‡∏±‡∏ô‡∏û‡∏§‡∏´‡∏±‡∏™‡∏ö‡∏î‡∏µ': 4, '‡∏û‡∏§‡∏´‡∏±‡∏™‡∏ö‡∏î‡∏µ': 4, '‡∏ß‡∏±‡∏ô‡∏û‡∏§‡∏´‡∏±‡∏™': 4, '‡∏û‡∏§‡∏´‡∏±‡∏™': 4,
                '‡∏ß‡∏±‡∏ô‡∏®‡∏∏‡∏Å‡∏£‡πå': 5, '‡∏®‡∏∏‡∏Å‡∏£‡πå': 5,
                '‡∏ß‡∏±‡∏ô‡πÄ‡∏™‡∏≤‡∏£‡πå': 6, '‡πÄ‡∏™‡∏≤‡∏£‡πå': 6,
                '‡∏ß‡∏±‡∏ô‡∏≠‡∏≤‡∏ó‡∏¥‡∏ï‡∏¢‡πå': 0, '‡∏≠‡∏≤‡∏ó‡∏¥‡∏ï‡∏¢‡πå': 0,
                '‡∏ß‡∏±‡∏ô‡∏ô‡∏µ‡πâ': 'today',
                '‡∏û‡∏£‡∏∏‡πà‡∏á‡∏ô‡∏µ‡πâ': 'tomorrow',
                '‡∏°‡∏∞‡∏£‡∏∑‡∏ô‡∏ô‡∏µ‡πâ': 'dayAfterTomorrow'
            };

            // ‡∏´‡∏≤‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó‡∏Ñ‡∏≥‡∏™‡∏±‡πà‡∏á
            if (text.includes('‡∏•‡∏ö') || text.includes('‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å')) {
                command.type = 'delete';
            } else if (text.includes('‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç') || text.includes('‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô')) {
                command.type = 'edit';
            } else {
                command.type = 'create';
            }

            // ‡∏´‡∏≤‡∏ä‡∏∑‡πà‡∏≠ event - ‡∏õ‡∏£‡∏±‡∏ö‡∏õ‡∏£‡∏∏‡∏á pattern matching
            const titlePatterns = [
                /(?:‡∏°‡∏µ|‡∏°‡∏µ‡∏ô‡∏±‡∏î|‡∏à‡∏∞)([^‡πÄ‡∏ß‡∏•‡∏≤]*?)(?=‡πÄ‡∏ß‡∏•‡∏≤|‡∏ï‡∏±‡πâ‡∏á‡πÅ‡∏ï‡πà|‡∏ñ‡∏∂‡∏á|$)/,
                /^([^‡πÄ‡∏ß‡∏•‡∏≤]*?)(?=‡πÄ‡∏ß‡∏•‡∏≤|‡∏ï‡∏±‡πâ‡∏á‡πÅ‡∏ï‡πà|‡∏ß‡∏±‡∏ô|$)/
            ];
            
            for (const pattern of titlePatterns) {
                const match = text.match(pattern);
                if (match && match[1] && match[1].trim()) {
                    command.title = match[1].trim();
                    break;
                }
            }

            // ‡∏´‡∏≤‡∏ß‡∏±‡∏ô
            const today = new Date();
            for (const [thaiDay, dayNum] of Object.entries(dayMap)) {
                if (text.includes(thaiDay)) {
                    if (dayNum === 'today') {
                        command.date = new Date(today);
                    } else if (dayNum === 'tomorrow') {
                        command.date = new Date(today.getTime() + 24 * 60 * 60 * 1000);
                    } else if (dayNum === 'dayAfterTomorrow') {
                        command.date = new Date(today.getTime() + 2 * 24 * 60 * 60 * 1000);
                    } else {
                        // ‡∏´‡∏≤‡∏ß‡∏±‡∏ô‡∏ñ‡∏±‡∏î‡πÑ‡∏õ‡∏ó‡∏µ‡πà‡∏ï‡∏£‡∏á‡∏Å‡∏±‡∏ö‡∏ß‡∏±‡∏ô‡πÉ‡∏ô‡∏™‡∏±‡∏õ‡∏î‡∏≤‡∏´‡πå
                        const nextDate = new Date(today);
                        const daysUntilTarget = (dayNum + 7 - today.getDay()) % 7;
                        nextDate.setDate(today.getDate() + (daysUntilTarget || 7));
                        command.date = nextDate;
                    }
                    break;
                }
            }

            // ‡∏´‡∏≤‡πÄ‡∏ß‡∏•‡∏≤ - ‡∏õ‡∏£‡∏±‡∏ö‡∏õ‡∏£‡∏∏‡∏á regex patterns
            const timePatterns = [
                /‡πÄ‡∏ß‡∏•‡∏≤\s*(\d{1,2})\.(\d{2})\s*‡∏ô\./g,
                /‡πÄ‡∏ß‡∏•‡∏≤\s*(\d{1,2})\s*‡πÇ‡∏°‡∏á\s*(\d{2})/g,
                /(\d{1,2})\s*‡πÇ‡∏°‡∏á(?:‡πÄ‡∏ä‡πâ‡∏≤|‡πÄ‡∏¢‡πá‡∏ô)?/g,
                /‡∏ï‡∏±‡πâ‡∏á‡πÅ‡∏ï‡πà\s*(\d{1,2})(?:\.(\d{2}))?\s*(?:‡πÇ‡∏°‡∏á(?:‡πÄ‡∏ä‡πâ‡∏≤)?)?/g,
                /‡∏ñ‡∏∂‡∏á\s*(\d{1,2})(?:\.(\d{2}))?\s*(?:‡πÇ‡∏°‡∏á)?/g
            ];

            let times = [];
            for (const pattern of timePatterns) {
                pattern.lastIndex = 0; // Reset regex
                let match;
                while ((match = pattern.exec(text)) !== null) {
                    const hour = parseInt(match[1]);
                    const minute = parseInt(match[2] || '0');
                    if (hour >= 0 && hour <= 23 && minute >= 0 && minute <= 59) {
                        times.push(`${hour.toString().padStart(2, '0')}:${minute.toString().padStart(2, '0')}`);
                    }
                }
            }

            if (times.length > 0) {
                command.startTime = times[0];
                if (times.length > 1) {
                    command.endTime = times[1];
                }
            }

            // ‡∏ñ‡πâ‡∏≤‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏ß‡∏±‡∏ô ‡πÉ‡∏ä‡πâ‡∏ß‡∏±‡∏ô‡∏ô‡∏µ‡πâ
            if (!command.date) {
                command.date = new Date(today);
            }

            // ‡∏ñ‡πâ‡∏≤‡πÑ‡∏°‡πà‡∏°‡∏µ‡πÄ‡∏ß‡∏•‡∏≤ ‡πÉ‡∏ä‡πâ 09:00
            if (!command.startTime) {
                command.startTime = '09:00';
            }

            // ‡∏Å‡∏≥‡∏´‡∏ô‡∏î endTime (1 ‡∏ä‡∏±‡πà‡∏ß‡πÇ‡∏°‡∏á‡∏´‡∏•‡∏±‡∏á start time)
            if (command.startTime && !command.endTime) {
                const [hour, minute] = command.startTime.split(':').map(Number);
                const endHour = hour + 1;
                command.endTime = `${endHour.toString().padStart(2, '0')}:${minute.toString().padStart(2, '0')}`;
            }

            return command;
        }

        // ‡πÅ‡∏™‡∏î‡∏á‡∏Ñ‡∏≥‡∏™‡∏±‡πà‡∏á‡∏ó‡∏µ‡πà‡πÅ‡∏õ‡∏•‡πÅ‡∏•‡πâ‡∏ß
        function displayParsedCommand(command) {
            const dateStr = command.date ? command.date.toLocaleDateString('th-TH', { 
                weekday: 'long', 
                year: 'numeric', 
                month: 'long', 
                day: 'numeric' 
            }) : '‡πÑ‡∏°‡πà‡∏£‡∏∞‡∏ö‡∏∏';

            commandDetails.innerHTML = `
                <strong>‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó:</strong> ${command.type === 'create' ? '‡∏™‡∏£‡πâ‡∏≤‡∏á Event' : command.type === 'delete' ? '‡∏•‡∏ö Event' : '‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç Event'}<br>
                <strong>‡∏ä‡∏∑‡πà‡∏≠:</strong> ${command.title || '‡πÑ‡∏°‡πà‡∏£‡∏∞‡∏ö‡∏∏'}<br>
                <strong>‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà:</strong> ${dateStr}<br>
                <strong>‡πÄ‡∏ß‡∏•‡∏≤‡πÄ‡∏£‡∏¥‡πà‡∏°:</strong> ${command.startTime || '‡πÑ‡∏°‡πà‡∏£‡∏∞‡∏ö‡∏∏'}<br>
                <strong>‡πÄ‡∏ß‡∏•‡∏≤‡∏à‡∏ö:</strong> ${command.endTime || '‡πÑ‡∏°‡πà‡∏£‡∏∞‡∏ö‡∏∏'}<br>
                <strong>‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î:</strong> ${command.description}
            `;
            
            parsedCommand.style.display = 'block';
            executeBtn.disabled = !isGoogleAuthorized || !command.title;
        }

        // ‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏Å‡∏≤‡∏£‡∏Ñ‡∏≥‡∏™‡∏±‡πà‡∏á Calendar
        async function executeCalendarCommand() {
            if (!currentCommand || !isGoogleAuthorized) return;

            try {
                addLog(`üöÄ ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏Å‡∏≤‡∏£: ${currentCommand.type}`);

                if (currentCommand.type === 'create') {
                    await createCalendarEvent(currentCommand);
                    // ‡∏™‡πà‡∏á‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à‡πÑ‡∏õ micro:bit
                    if (isConnected && writer) {
                        await writer.write('CALENDAR_SUCCESS\n');
                    }
                } else if (currentCommand.type === 'delete') {
                    await deleteCalendarEvent(currentCommand);
                    if (isConnected && writer) {
                        await writer.write('CALENDAR_SUCCESS\n');
                    }
                }

            } catch (error) {
                addLog(`‚ùå ‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏Å‡∏≤‡∏£‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à: ${error.message}`);
                // ‡∏™‡πà‡∏á‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÑ‡∏õ micro:bit
                if (isConnected && writer) {
                    await writer.write('CALENDAR_ERROR\n');
                }
            }
        }

        // ‡∏™‡∏£‡πâ‡∏≤‡∏á Calendar Event
        async function createCalendarEvent(command) {
            const startDateTime = new Date(command.date);
            const endDateTime = new Date(command.date);
            
            const [startHour, startMinute] = command.startTime.split(':').map(Number);
            const [endHour, endMinute] = command.endTime.split(':').map(Number);
            
            startDateTime.setHours(startHour, startMinute, 0);
            endDateTime.setHours(endHour, endMinute, 0);

            const event = {
                summary: command.title,
                description: `‡∏™‡∏£‡πâ‡∏≤‡∏á‡πÇ‡∏î‡∏¢ Thai Voice Assistant\n${command.description}`,
                start: {
                    dateTime: startDateTime.toISOString(),
                    timeZone: 'Asia/Bangkok'
                },
                end: {
                    dateTime: endDateTime.toISOString(),
                    timeZone: 'Asia/Bangkok'
                }
            };

            const response = await gapi.client.calendar.events.insert({
                calendarId: 'primary',
                resource: event
            });

            addLog(`‚úÖ ‡∏™‡∏£‡πâ‡∏≤‡∏á Event ‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à: "${command.title}"`);
            status.textContent = `‚úÖ ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÉ‡∏ô‡∏õ‡∏è‡∏¥‡∏ó‡∏¥‡∏ô‡πÅ‡∏•‡πâ‡∏ß: "${command.title}"`;
        }

        // ‡∏•‡∏ö Calendar Event
        async function deleteCalendarEvent(command) {
            // ‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤ events ‡πÉ‡∏ô‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏Å‡∏≥‡∏´‡∏ô‡∏î
            const startDate = new Date(command.date);
            startDate.setHours(0, 0, 0, 0);
            const endDate = new Date(command.date);
            endDate.setHours(23, 59, 59, 999);

            const response = await gapi.client.calendar.events.list({
                calendarId: 'primary',
                timeMin: startDate.toISOString(),
                timeMax: endDate.toISOString(),
                singleEvents: true,
                orderBy: 'startTime'
            });

            const events = response.result.items || [];
            let deletedCount = 0;

            for (const event of events) {
                if (command.title && event.summary && 
                    event.summary.toLowerCase().includes(command.title.toLowerCase())) {
                    await gapi.client.calendar.events.delete({
                        calendarId: 'primary',
                        eventId: event.id
                    });
                    deletedCount++;
                }
            }

            addLog(`‚úÖ ‡∏•‡∏ö Event ‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à: ${deletedCount} ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£`);
            status.textContent = `‚úÖ ‡∏•‡∏ö Event ‡πÅ‡∏•‡πâ‡∏ß: ${deletedCount} ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£`;
        }

        // ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ó‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞
        function updateStatus() {
            if (!isConnected && !isGoogleAuthorized) {
                status.textContent = '‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤ Google API ‡πÅ‡∏•‡∏∞‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠ micro:bit ‡∏Å‡πà‡∏≠‡∏ô';
            } else if (!isConnected) {
                status.textContent = '‡∏Å‡∏î‡∏õ‡∏∏‡πà‡∏° "‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠ micro:bit" ‡∏Å‡πà‡∏≠‡∏ô';
            } else if (!isGoogleAuthorized) {
                status.textContent = '‡∏Å‡∏î‡∏õ‡∏∏‡πà‡∏° "‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö Google" ‡∏Å‡πà‡∏≠‡∏ô';
            } else {
                status.textContent = '‡∏û‡∏£‡πâ‡∏≠‡∏°‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô - ‡∏Å‡∏î A (Calendar) ‡∏´‡∏£‡∏∑‡∏≠ B (‡∏ó‡∏±‡πà‡∏ß‡πÑ‡∏õ) ‡∏ö‡∏ô micro:bit ‡πÅ‡∏•‡πâ‡∏ß‡∏û‡∏π‡∏î!';
            }
            updateDebugInfo();
        }

        // ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏Å‡∏≤‡∏£‡∏£‡∏≠‡∏á‡∏£‡∏±‡∏ö Web Serial API
        if (!('serial' in navigator)) {
            addLog('‚ùå ‡πÄ‡∏ö‡∏£‡∏≤‡∏ß‡πå‡πÄ‡∏ã‡∏≠‡∏£‡πå‡πÑ‡∏°‡πà‡∏£‡∏≠‡∏á‡∏£‡∏±‡∏ö Web Serial API');
            addLog('üí° ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÉ‡∏ä‡πâ Chrome ‡∏´‡∏£‡∏∑‡∏≠ Edge ‡πÄ‡∏ß‡∏≠‡∏£‡πå‡∏ä‡∏±‡∏ô‡πÉ‡∏´‡∏°‡πà');
            connectBtn.disabled = true;
        }

        // ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏Å‡∏≤‡∏£‡∏£‡∏≠‡∏á‡∏£‡∏±‡∏ö Speech Recognition
        if (!('webkitSpeechRecognition' in window) && !('SpeechRecognition' in window)) {
            addLog('‚ùå ‡πÄ‡∏ö‡∏£‡∏≤‡∏ß‡πå‡πÄ‡∏ã‡∏≠‡∏£‡πå‡πÑ‡∏°‡πà‡∏£‡∏≠‡∏á‡∏£‡∏±‡∏ö Speech Recognition');
            startBtn.disabled = true;
        } else {
            // ‡∏™‡∏£‡πâ‡∏≤‡∏á Speech Recognition
            recognition = new (window.SpeechRecognition || window.webkitSpeechRecognition)();
            recognition.continuous = false;
            recognition.interimResults = true;
            recognition.lang = 'th-TH';
            recognition.maxAlternatives = 1;

            // Speech Recognition Events
            recognition.onstart = () => {
                const modeText = commandMode === 'CALENDAR' ? 'Calendar üìÖ' : '‡∏ó‡∏±‡πà‡∏ß‡πÑ‡∏õ üí¨';
                status.innerHTML = `üé§ ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ü‡∏±‡∏á (‡πÇ‡∏´‡∏°‡∏î: ${modeText}) - <span style="color: #ff6b6b;">‡∏û‡∏π‡∏î‡πÄ‡∏•‡∏¢!</span>`;
                startBtn.disabled = true;
                stopBtn.disabled = false;
                isListening = true;
                result.style.border = '3px solid #ff6b6b';
                addLog(`üé§ ‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ü‡∏±‡∏á‡πÄ‡∏™‡∏µ‡∏¢‡∏á - ‡πÇ‡∏´‡∏°‡∏î: ${modeText}`);
            };

            recognition.onresult = (event) => {
                let interimTranscript = '';
                let finalTranscript = '';
                
                for (let i = event.resultIndex; i < event.results.length; i++) {
                    const transcript = event.results[i][0].transcript;
                    if (event.results[i].isFinal) {
                        finalTranscript += transcript;
                    } else {
                        interimTranscript += transcript;
                    }
                }
                
                result.innerHTML = (finalTranscript || interimTranscript) || '‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏£‡∏π‡πâ‡∏à‡∏≥‡πÄ‡∏™‡∏µ‡∏¢‡∏á...';
                
                if (finalTranscript) {
                    currentText = finalTranscript;
                    addLog(`‚úÖ ‡∏£‡∏π‡πâ‡∏à‡∏≥‡πÑ‡∏î‡πâ: "${finalTranscript}"`);
                    
                    if (commandMode === 'CALENDAR') {
                        // ‡πÅ‡∏õ‡∏•‡∏á‡πÄ‡∏õ‡πá‡∏ô‡∏Ñ‡∏≥‡∏™‡∏±‡πà‡∏á Calendar
                        currentCommand = parseThaiCommand(finalTranscript);
                        displayParsedCommand(currentCommand);
                        addLog(`üìã ‡πÅ‡∏õ‡∏•‡∏Ñ‡∏≥‡∏™‡∏±‡πà‡∏á: ${currentCommand.type} - "${currentCommand.title}"`);
                        
                        // ‡∏™‡πà‡∏á‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡πÑ‡∏õ micro:bit
                        if (isConnected && writer) {
                            setTimeout(() => sendToMicrobit(), 500);
                        }
                    } else {
                        // ‡πÇ‡∏´‡∏°‡∏î‡∏ó‡∏±‡πà‡∏ß‡πÑ‡∏õ - ‡∏™‡πà‡∏á‡πÑ‡∏õ micro:bit
                        if (isConnected && writer) {
                            setTimeout(() => sendToMicrobit(), 500);
                        }
                    }
                }
            };

            recognition.onerror = (event) => {
                let errorMsg = '';
                switch(event.error) {
                    case 'no-speech':
                        errorMsg = 'üîá ‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ‡∏¢‡∏¥‡∏ô‡πÄ‡∏™‡∏µ‡∏¢‡∏á‡∏û‡∏π‡∏î';
                        break;
                    case 'audio-capture':
                        errorMsg = 'üé§ ‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÄ‡∏Ç‡πâ‡∏≤‡∏ñ‡∏∂‡∏á‡πÑ‡∏°‡πÇ‡∏Ñ‡∏£‡πÇ‡∏ü‡∏ô‡πÑ‡∏î‡πâ';
                        break;
                    case 'not-allowed':
                        errorMsg = '‚ùå ‡πÑ‡∏°‡πà‡∏≠‡∏ô‡∏∏‡∏ç‡∏≤‡∏ï‡πÉ‡∏´‡πâ‡πÉ‡∏ä‡πâ‡πÑ‡∏°‡πÇ‡∏Ñ‡∏£‡πÇ‡∏ü‡∏ô';
                        break;
                    case 'network':
                        errorMsg = 'üåê ‡πÄ‡∏Ñ‡∏£‡∏∑‡∏≠‡∏Ç‡πà‡∏≤‡∏¢‡∏°‡∏µ‡∏õ‡∏±‡∏ç‡∏´‡∏≤';
                        break;
                    default:
                        errorMsg = '‚ùå ‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î: ' + event.error;
                }
                status.textContent = errorMsg;
                addLog(`‚ùå ‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î Speech: ${event.error}`);
                resetSpeechButtons();
            };

            recognition.onend = () => {
                updateStatus();
                addLog('‚èπÔ∏è ‡∏´‡∏¢‡∏∏‡∏î‡∏ü‡∏±‡∏á‡πÄ‡∏™‡∏µ‡∏¢‡∏á‡πÅ‡∏•‡πâ‡∏ß');
                resetSpeechButtons();
            };
        }

        // ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏£‡∏µ‡πÄ‡∏ã‡πá‡∏ï‡∏õ‡∏∏‡πà‡∏° Speech
        function resetSpeechButtons() {
            startBtn.disabled = false;
            stopBtn.disabled = true;
            isListening = false;
            result.style.border = 'none';
        }

        // ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠ micro:bit
        async function connectToMicrobit() {
            try {
                addLog('üîå ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠ micro:bit...');
                
                // ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö Web Serial API
                if (!navigator.serial) {
                    throw new Error('‡πÄ‡∏ö‡∏£‡∏≤‡∏ß‡πå‡πÄ‡∏ã‡∏≠‡∏£‡πå‡πÑ‡∏°‡πà‡∏£‡∏≠‡∏á‡∏£‡∏±‡∏ö Web Serial API');
                }
                
                port = await navigator.serial.requestPort({
                    filters: [
                        { usbVendorId: 0x0D28 }, // micro:bit vendor ID
                        { usbVendorId: 0x239A }  // CircuitPython vendor ID
                    ]
                });
                
                await port.open({ 
                    baudRate: 115200,
                    dataBits: 8,
                    stopBits: 1,
                    parity: 'none'
                });
                
                const textDecoder = new TextDecoderStream();
                const readableStreamClosed = port.readable.pipeTo(textDecoder.writable);
                reader = textDecoder.readable.getReader();
                
                const textEncoder = new TextEncoderStream();
                const writableStreamClosed = textEncoder.readable.pipeTo(port.writable);
                writer = textEncoder.writable.getWriter();
                
                isConnected = true;
                connectBtn.disabled = true;
                disconnectBtn.disabled = false;
                
                microbitStatus.innerHTML = '‚úÖ ‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠ micro:bit ‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à';
                microbitStatus.className = 'success';
                updateStatus();
                
                addLog('‚úÖ ‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠ micro:bit ‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à');
                
                // ‡∏™‡πà‡∏á‡∏™‡∏±‡∏ç‡∏ç‡∏≤‡∏ì‡∏ß‡πà‡∏≤‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠‡πÅ‡∏•‡πâ‡∏ß
                await writer.write('CONNECTED\n');
                
                // ‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏≠‡πà‡∏≤‡∏ô‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏à‡∏≤‡∏Å micro:bit
                readFromMicrobit();
                
            } catch (error) {
                addLog(`‚ùå ‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à: ${error.message}`);
                microbitStatus.innerHTML = '‚ùå ‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à';
                microbitStatus.className = 'error';
                
                if (error.message.includes('No port selected')) {
                    addLog('üí° ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å micro:bit ‡πÉ‡∏ô‡∏´‡∏ô‡πâ‡∏≤‡∏ï‡πà‡∏≤‡∏á popup');
                } else if (error.message.includes('Access denied')) {
                    addLog('üí° ‡∏≠‡∏≤‡∏à‡∏ï‡πâ‡∏≠‡∏á‡∏õ‡∏¥‡∏î MakeCode ‡∏´‡∏£‡∏∑‡∏≠‡πÇ‡∏õ‡∏£‡πÅ‡∏Å‡∏£‡∏°‡∏≠‡∏∑‡πà‡∏ô‡∏ó‡∏µ‡πà‡πÉ‡∏ä‡πâ micro:bit');
                }
            }
        }

        // ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏≠‡πà‡∏≤‡∏ô‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏à‡∏≤‡∏Å micro:bit - ‡πÄ‡∏û‡∏¥‡πà‡∏° error handling
        async function readFromMicrobit() {
            try {
                while (isConnected && reader) {
                    const { value, done } = await reader.read();
                    if (done) break;
                    
                    const message = value.trim();
                    if (message) {
                        addLog(`üì® ‡∏à‡∏≤‡∏Å micro:bit: ${message}`);
                        
                        if (message === 'START_VOICE_CALENDAR') {
                            commandMode = 'CALENDAR';
                            addLog('üìÖ ‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡πÄ‡∏õ‡πá‡∏ô‡πÇ‡∏´‡∏°‡∏î Calendar');
                            if (!isListening && recognition) {
                                setTimeout(() => startSpeechRecognition(), 500);
                            }
                        } else if (message === 'GENERAL_COMMAND') {
                            commandMode = 'GENERAL';
                            addLog('üí¨ ‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡πÄ‡∏õ‡πá‡∏ô‡πÇ‡∏´‡∏°‡∏î‡∏ó‡∏±‡πà‡∏ß‡πÑ‡∏õ');
                            if (!isListening && recognition) {
                                setTimeout(() => startSpeechRecognition(), 500);
                            }
                        }
                    }
                }
            } catch (error) {
                if (isConnected) {
                    addLog(`‚ùå ‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏≠‡πà‡∏≤‡∏ô: ${error.message}`);
                    // ‡∏û‡∏¢‡∏≤‡∏¢‡∏≤‡∏°‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠‡πÉ‡∏´‡∏°‡πà
                    setTimeout(() => {
                        if (isConnected) {
                            addLog('üîÑ ‡∏û‡∏¢‡∏≤‡∏¢‡∏≤‡∏°‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠‡πÉ‡∏´‡∏°‡πà...');
                            readFromMicrobit();
                        }
                    }, 2000);
                }
            }
        }

        // ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏™‡πà‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÑ‡∏õ micro:bit
        async function sendToMicrobit() {
            if (!isConnected || !currentText || !writer) return;
            
            try {
                let romanizedText = convertThaiToRoman(currentText);
                
                await writer.write(`VOICE_TEXT:${romanizedText}\n`);
                addLog(`üì§ ‡∏™‡πà‡∏á‡πÑ‡∏õ micro:bit: "${romanizedText}" (‡∏à‡∏≤‡∏Å‡πÑ‡∏ó‡∏¢: "${currentText}")`);
                status.textContent = `üì§ ‡∏™‡πà‡∏á‡πÅ‡∏•‡πâ‡∏ß: "${romanizedText}"`;
            } catch (error) {
                addLog(`‚ùå ‡∏™‡πà‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à: ${error.message}`);
                if (writer) {
                    try {
                        await writer.write('VOICE_ERROR\n');
                    } catch (e) {
                        addLog('‚ùå ‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏™‡πà‡∏á‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏° error ‡πÑ‡∏î‡πâ');
                    }
                }
            }
        }

        // ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡πÅ‡∏õ‡∏•‡∏á‡πÑ‡∏ó‡∏¢‡πÄ‡∏õ‡πá‡∏ô‡πÇ‡∏£‡∏°‡∏±‡∏ô
        function convertThaiToRoman(thaiText) {
            const thaiToRoman = {
                '‡∏Å': 'ga', '‡∏Ç': 'kha', '‡∏Ñ': 'kha', '‡∏á': 'nga',
                '‡∏à': 'ja', '‡∏â': 'cha', '‡∏ä': 'cha', '‡∏ã': 'sa', '‡∏å': 'cha', '‡∏ç': 'nya',
                '‡∏î': 'da', '‡∏ï': 'ta', '‡∏ñ': 'tha', '‡∏ó': 'tha', '‡∏ò': 'tha', '‡∏ô': 'na', '‡∏ö': 'pa',
                '‡∏õ': 'pa', '‡∏ú': 'pha', '‡∏ù': 'fa', '‡∏û': 'pha', '‡∏ü': 'fa', '‡∏†': 'pha', '‡∏°': 'ma',
                '‡∏¢': 'ya', '‡∏£': 'ra', '‡∏•': 'la', '‡∏ß': 'wa',
                '‡∏®': 'sa', '‡∏©': 'sa', '‡∏™': 'sa', '‡∏´': 'ha', '‡∏¨': 'la', '‡∏≠': 'o', '‡∏Æ': 'ha',
                '‡πê': '0', '‡πë': '1', '‡πí': '2', '‡πì': '3', '‡πî': '4', '‡πï': '5', '‡πñ': '6', '‡πó': '7', '‡πò': '8', '‡πô': '9',
                '‡∏≤': 'aa', '‡∏¥': 'i', '‡∏µ': 'ii', '‡∏∂': 'ue', '‡∏∑': 'uu', '‡∏∏': 'u', '‡∏π': 'uu',
                '‡πÄ': 'e', '‡πÅ': 'ae', '‡πÇ': 'o', '‡πÉ': 'ai', '‡πÑ': 'ai',
                '‡∏≥': 'am', '‡∏±': 'a', '‡πá': '', '‡πå': '',
                '‡πà': '1', '‡πâ': '2', '‡πä': '3', '‡πã': '4',
                '‡∏™‡∏ß‡∏±‡∏™‡∏î‡∏µ': 'sawasdee', '‡∏Ç‡∏≠‡∏ö‡∏Ñ‡∏∏‡∏ì': 'khobkhun', '‡∏•‡∏≤‡∏Å‡πà‡∏≠‡∏ô': 'laagoon',
                ' ': ' '
            };

            let result = '';
            for (let i = 0; i < thaiText.length; i++) {
                let char = thaiText[i];
                if (thaiToRoman[char]) {
                    result += thaiToRoman[char];
                } else if (char.match(/[a-zA-Z0-9\s]/)) {
                    result += char;
                } else {
                    result += '?';
                }
            }

            if (result.length > 50) {
                result = result.substring(0, 47) + '...';
            }

            return result || 'Thai Text';
        }

        // ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡πÄ‡∏£‡∏¥‡πà‡∏° Speech Recognition
        function startSpeechRecognition() {
            if (!recognition || isListening) return;
            
            try {
                recognition.start();
            } catch (error) {
                addLog(`‚ùå ‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ü‡∏±‡∏á‡πÑ‡∏î‡πâ: ${error.message}`);
                resetSpeechButtons();
            }
        }

        // ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏´‡∏¢‡∏∏‡∏î Speech Recognition
        function stopSpeechRecognition() {
            if (recognition && isListening) {
                recognition.stop();
            }
        }

        // ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏ï‡∏±‡∏î‡∏Å‡∏≤‡∏£‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠
        async function disconnect() {
            try {
                isConnected = false;
                
                if (reader) {
                    await reader.cancel();
                    reader = null;
                }
                
                if (writer) {
                    await writer.close();
                    writer = null;
                }
                
                if (port) {
                    await port.close();
                    port = null;
                }
                
                connectBtn.disabled = false;
                disconnectBtn.disabled = true;
                
                microbitStatus.innerHTML = '‡∏ï‡∏±‡∏î‡∏Å‡∏≤‡∏£‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠‡πÅ‡∏•‡πâ‡∏ß';
                microbitStatus.className = '';
                updateStatus();
                
                addLog('üîå ‡∏ï‡∏±‡∏î‡∏Å‡∏≤‡∏£‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠‡πÅ‡∏•‡πâ‡∏ß');
                
            } catch (error) {
                addLog(`‚ùå ‡∏ï‡∏±‡∏î‡∏Å‡∏≤‡∏£‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à: ${error.message}`);
            }
        }

        // ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏•‡πâ‡∏≤‡∏á‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°
        function clearText() {
            currentText = '';
            currentCommand = null;
            result.innerHTML = '‡∏Ñ‡∏≥‡∏™‡∏±‡πà‡∏á‡∏ó‡∏µ‡πà‡∏£‡∏π‡πâ‡∏à‡∏≥‡πÑ‡∏î‡πâ‡∏à‡∏∞‡πÅ‡∏™‡∏î‡∏á‡∏ó‡∏µ‡πà‡∏ô‡∏µ‡πà...';
            parsedCommand.style.display = 'none';
            executeBtn.disabled = true;
            addLog('üóëÔ∏è ‡∏•‡πâ‡∏≤‡∏á‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡πÅ‡∏•‡πâ‡∏ß');
            updateStatus();
        }

        // Event Listeners
        saveClientIdBtn.addEventListener('click', saveClientId);
        authBtn.addEventListener('click', signIn);
        signoutBtn.addEventListener('click', signOut);
        testApiBtn.addEventListener('click', testAPI);
        connectBtn.addEventListener('click', connectToMicrobit);
        disconnectBtn.addEventListener('click', disconnect);
        startBtn.addEventListener('click', startSpeechRecognition);
        stopBtn.addEventListener('click', stopSpeechRecognition);
        executeBtn.addEventListener('click', executeCalendarCommand);
        clearBtn.addEventListener('click', clearText);

        // Keyboard shortcuts
        document.addEventListener('keydown', (event) => {
            switch(event.code) {
                case 'Space':
                    if (!isListening && recognition) {
                        event.preventDefault();
                        startSpeechRecognition();
                    }
                    break;
                case 'Escape':
                    if (isListening) {
                        event.preventDefault();
                        stopSpeechRecognition();
                    }
                    break;
                case 'Enter':
                    if (currentCommand && isGoogleAuthorized) {
                        event.preventDefault();
                        executeCalendarCommand();
                    }
                    break;
            }
        });

        // ‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô‡∏£‡∏∞‡∏ö‡∏ö
        addLog('üöÄ ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô‡∏£‡∏∞‡∏ö‡∏ö...');
        
        // ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö HTTPS
        if (location.protocol !== 'https:' && location.hostname !== 'localhost') {
            addLog('‚ö†Ô∏è ‡∏Ñ‡∏ß‡∏£‡πÉ‡∏ä‡πâ HTTPS ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö Web Serial API');
        }
        
        updateStatus();
        
        // ‡πÄ‡∏ä‡πá‡∏Ñ‡∏Å‡∏≤‡∏£‡∏£‡∏≠‡∏á‡∏£‡∏±‡∏ö APIs - ‡πÄ‡∏û‡∏¥‡πà‡∏° timeout
        setTimeout(() => {
            updateDebugInfo();
            
            if ('serial' in navigator) {
                addLog('‚úÖ Web Serial API ‡∏û‡∏£‡πâ‡∏≠‡∏°‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô');
            } else {
                addLog('‚ùå Web Serial API ‡πÑ‡∏°‡πà‡∏£‡∏≠‡∏á‡∏£‡∏±‡∏ö - ‡πÉ‡∏ä‡πâ Chrome/Edge ‡πÄ‡∏ß‡∏≠‡∏£‡πå‡∏ä‡∏±‡∏ô‡πÉ‡∏´‡∏°‡πà');
            }
            
            if ('webkitSpeechRecognition' in window || 'SpeechRecognition' in window) {
                addLog('‚úÖ Speech Recognition API ‡∏û‡∏£‡πâ‡∏≠‡∏°‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô');
            } else {
                addLog('‚ùå Speech Recognition API ‡πÑ‡∏°‡πà‡∏£‡∏≠‡∏á‡∏£‡∏±‡∏ö');
            }
            
            // ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö Google APIs script
            if (typeof gapi === 'undefined') {
                addLog('‚ùå Google APIs script ‡πÑ‡∏°‡πà‡πÇ‡∏´‡∏•‡∏î - ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏Å‡∏≤‡∏£‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠');
                authBtn.disabled = true;
            }
        }, 2000);

    </script>
    <script src="https://apis.google.com/js/api.js" async defer onload="addLog('‚úÖ Google APIs script ‡πÇ‡∏´‡∏•‡∏î‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à'); updateDebugInfo();" onerror="addLog('‚ùå Google APIs script ‡πÇ‡∏´‡∏•‡∏î‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à'); updateDebugInfo();"></script>
</body>
</html>
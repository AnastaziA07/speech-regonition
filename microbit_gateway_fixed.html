<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Robot Assistant Mobile Gateway</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            display: flex;
            flex-direction: column;
            color: white;
        }
        
        .container {
            max-width: 400px;
            margin: 0 auto;
            padding: 20px;
            flex: 1;
        }
        
        .header {
            text-align: center;
            margin-bottom: 30px;
            padding: 20px;
            background: rgba(255,255,255,0.1);
            border-radius: 15px;
            backdrop-filter: blur(10px);
        }
        
        .robot-icon {
            font-size: 3rem;
            margin-bottom: 10px;
            animation: bounce 2s infinite;
        }
        
        @keyframes bounce {
            0%, 20%, 50%, 80%, 100% {
                transform: translateY(0);
            }
            40% {
                transform: translateY(-10px);
            }
            60% {
                transform: translateY(-5px);
            }
        }
        
        .status {
            background: rgba(255,255,255,0.15);
            padding: 15px;
            border-radius: 10px;
            margin-bottom: 20px;
            text-align: center;
        }
        
        .status.connected {
            background: rgba(76, 175, 80, 0.3);
        }
        
        .status.disconnected {
            background: rgba(244, 67, 54, 0.3);
        }

        .status.connecting {
            background: rgba(255, 152, 0, 0.3);
        }
        
        .feature-list {
            background: rgba(255,255,255,0.1);
            border-radius: 15px;
            padding: 20px;
            margin-bottom: 20px;
        }
        
        .feature-item {
            display: flex;
            align-items: center;
            padding: 15px 0;
            border-bottom: 1px solid rgba(255,255,255,0.1);
        }
        
        .feature-item:last-child {
            border-bottom: none;
        }
        
        .feature-icon {
            font-size: 1.5rem;
            margin-right: 15px;
            width: 40px;
            text-align: center;
        }
        
        .feature-text {
            flex: 1;
        }
        
        .feature-title {
            font-weight: bold;
            margin-bottom: 5px;
        }
        
        .feature-desc {
            font-size: 0.9rem;
            opacity: 0.8;
        }
        
        .connect-btn {
            width: 100%;
            padding: 15px;
            background: linear-gradient(45deg, #4CAF50, #45a049);
            border: none;
            border-radius: 10px;
            color: white;
            font-size: 1.1rem;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s ease;
        }
        
        .connect-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(76, 175, 80, 0.4);
        }
        
        .connect-btn:disabled {
            background: linear-gradient(45deg, #9E9E9E, #757575);
            cursor: not-allowed;
            transform: none;
        }

        .connect-btn.connecting {
            background: linear-gradient(45deg, #FF9800, #F57C00);
        }
        
        .emergency-btn {
            width: 100%;
            padding: 15px;
            background: linear-gradient(45deg, #f44336, #d32f2f);
            border: none;
            border-radius: 10px;
            color: white;
            font-size: 1.1rem;
            font-weight: bold;
            cursor: pointer;
            margin-top: 10px;
            transition: all 0.3s ease;
        }
        
        .emergency-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(244, 67, 54, 0.4);
        }

        .debug-info {
            background: rgba(0,0,0,0.3);
            border-radius: 10px;
            padding: 15px;
            margin-top: 20px;
            font-size: 0.85rem;
        }

        .debug-info h4 {
            margin-bottom: 10px;
            color: #FFD54F;
        }
        
        .log {
            background: rgba(0,0,0,0.3);
            border-radius: 10px;
            padding: 15px;
            margin-top: 20px;
            max-height: 200px;
            overflow-y: auto;
        }
        
        .log-item {
            padding: 5px 0;
            border-bottom: 1px solid rgba(255,255,255,0.1);
            font-size: 0.9rem;
        }
        
        .log-item:last-child {
            border-bottom: none;
        }
        
        .timestamp {
            opacity: 0.7;
            font-size: 0.8rem;
        }

        .error {
            color: #FF6B6B;
        }

        .success {
            color: #4ECDC4;
        }

        .warning {
            color: #FFE66D;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <div class="robot-icon">ü§ñ</div>
            <h1>Robot Assistant</h1>
            <p>Mobile Gateway</p>
        </div>
        
        <div class="status" id="connectionStatus">
            <strong>‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞:</strong> <span id="statusText">‡∏£‡∏≠‡∏Å‡∏≤‡∏£‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠</span>
        </div>
        
        <div class="feature-list">
            <div class="feature-item">
                <div class="feature-icon">üìÖ</div>
                <div class="feature-text">
                    <div class="feature-title">Google Calendar Sync</div>
                    <div class="feature-desc">‡∏ã‡∏¥‡∏á‡∏Ñ‡πå‡∏Å‡∏≥‡∏´‡∏ô‡∏î‡∏Å‡∏≤‡∏£‡∏≠‡∏±‡∏ï‡πÇ‡∏ô‡∏°‡∏±‡∏ï‡∏¥</div>
                </div>
            </div>
            
            <div class="feature-item">
                <div class="feature-icon">üö®</div>
                <div class="feature-text">
                    <div class="feature-title">Emergency Call</div>
                    <div class="feature-desc">‡πÇ‡∏ó‡∏£‡πÑ‡∏õ‡πÄ‡∏ö‡∏≠‡∏£‡πå‡∏â‡∏∏‡∏Å‡πÄ‡∏â‡∏¥‡∏ô 1669</div>
                </div>
            </div>
            
            <div class="feature-item">
                <div class="feature-icon">üì±</div>
                <div class="feature-text">
                    <div class="feature-title">Push Notifications</div>
                    <div class="feature-desc">‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô‡∏ú‡πà‡∏≤‡∏ô‡∏°‡∏∑‡∏≠‡∏ñ‡∏∑‡∏≠</div>
                </div>
            </div>
            
            <div class="feature-item">
                <div class="feature-icon">üë•</div>
                <div class="feature-text">
                    <div class="feature-title">Family Alert</div>
                    <div class="feature-desc">‡πÅ‡∏à‡πâ‡∏á‡∏Ñ‡∏£‡∏≠‡∏ö‡∏Ñ‡∏£‡∏±‡∏ß‡πÄ‡∏°‡∏∑‡πà‡∏≠‡∏°‡∏µ‡∏õ‡∏±‡∏ç‡∏´‡∏≤</div>
                </div>
            </div>
        </div>
        
        <button class="connect-btn" id="connectBtn" onclick="toggleConnection()">
            ‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠‡∏Å‡∏±‡∏ö‡∏´‡∏∏‡πà‡∏ô‡∏¢‡∏ô‡∏ï‡πå
        </button>
        
        <button class="emergency-btn" id="emergencyBtn" onclick="makeEmergencyCall()" disabled>
            üö® ‡πÇ‡∏ó‡∏£‡∏â‡∏∏‡∏Å‡πÄ‡∏â‡∏¥‡∏ô 1669
        </button>

        <div class="debug-info" id="debugInfo">
            <h4>üîß Debug Information</h4>
            <div id="debugContent">
                <p>Browser: <span id="browserInfo"></span></p>
                <p>Bluetooth Support: <span id="bluetoothSupport"></span></p>
                <p>HTTPS: <span id="httpsStatus"></span></p>
            </div>
        </div>
        
        <div class="log" id="activityLog">
            <div class="log-item">
                <span class="timestamp">10:30:15</span> - ‡∏£‡∏∞‡∏ö‡∏ö‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ó‡∏≥‡∏á‡∏≤‡∏ô
            </div>
        </div>
    </div>

    <script>
        let isConnected = false;
        let bluetoothDevice = null;
        let characteristic = null;
        let isConnecting = false;
        
        // Service ‡πÅ‡∏•‡∏∞ Characteristic UUIDs ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö micro:bit
        // ‡πÉ‡∏ä‡πâ UART service ‡∏ó‡∏µ‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á
        const UART_SERVICE_UUID = '6e400001-b5a3-f393-e0a9-e50e24dcca9e';
        const UART_TX_CHARACTERISTIC_UUID = '6e400002-b5a3-f393-e0a9-e50e24dcca9e'; // TX (write)
        const UART_RX_CHARACTERISTIC_UUID = '6e400003-b5a3-f393-e0a9-e50e24dcca9e'; // RX (notify)
        
        // Initialize debug info
        function initDebugInfo() {
            const browserInfo = navigator.userAgent.split(')')[0].split('(')[1] || 'Unknown';
            const bluetoothSupport = 'bluetooth' in navigator ? '‚úÖ Supported' : '‚ùå Not Supported';
            const httpsStatus = window.location.protocol === 'https:' ? '‚úÖ Secure' : '‚ùå Insecure (Bluetooth requires HTTPS)';
            
            document.getElementById('browserInfo').textContent = browserInfo;
            document.getElementById('bluetoothSupport').textContent = bluetoothSupport;
            document.getElementById('httpsStatus').textContent = httpsStatus;
            
            if (!('bluetooth' in navigator)) {
                addLog('‚ùå Browser ‡πÑ‡∏°‡πà‡∏£‡∏≠‡∏á‡∏£‡∏±‡∏ö Web Bluetooth API', 'error');
                document.getElementById('connectBtn').disabled = true;
                document.getElementById('connectBtn').textContent = '‡πÑ‡∏°‡πà‡∏£‡∏≠‡∏á‡∏£‡∏±‡∏ö Bluetooth';
            } else if (window.location.protocol !== 'https:') {
                addLog('‚ö†Ô∏è ‡∏à‡∏≥‡πÄ‡∏õ‡πá‡∏ô‡∏ï‡πâ‡∏≠‡∏á‡πÉ‡∏ä‡πâ HTTPS ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö Bluetooth', 'warning');
            }
        }
        
        function addLog(message, type = 'info') {
            const log = document.getElementById('activityLog');
            const now = new Date();
            const timestamp = now.toLocaleTimeString('th-TH');
            
            const logItem = document.createElement('div');
            logItem.className = `log-item ${type}`;
            logItem.innerHTML = `<span class="timestamp">${timestamp}</span> - ${message}`;
            
            log.insertBefore(logItem, log.firstChild);
            
            // ‡πÄ‡∏Å‡πá‡∏ö‡πÅ‡∏Ñ‡πà 15 ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î
            while (log.children.length > 15) {
                log.removeChild(log.lastChild);
            }
            
            console.log(`[${timestamp}] ${message}`);
        }
        
        async function toggleConnection() {
            if (isConnecting) {
                addLog('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏£‡∏≠... ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠‡∏≠‡∏¢‡∏π‡πà', 'warning');
                return;
            }
            
            if (!isConnected) {
                await connectToBluetooth();
            } else {
                disconnect();
            }
        }
        
        async function connectToBluetooth() {
            if (isConnecting) return;
            
            try {
                isConnecting = true;
                const connectBtn = document.getElementById('connectBtn');
                const statusDiv = document.getElementById('connectionStatus');
                const statusText = document.getElementById('statusText');
                const emergencyBtn = document.getElementById('emergencyBtn');
                
                connectBtn.textContent = '‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠...';
                connectBtn.className = 'connect-btn connecting';
                connectBtn.disabled = true;
                statusDiv.className = 'status connecting';
                statusText.textContent = '‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡∏≠‡∏∏‡∏õ‡∏Å‡∏£‡∏ì‡πå';
                
                addLog('üîç ‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡∏≠‡∏∏‡∏õ‡∏Å‡∏£‡∏ì‡πå micro:bit...', 'info');
                
                // ‡∏Ç‡∏≠ permission ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö Bluetooth
                const options = {
                    filters: [
                        { namePrefix: 'BBC micro:bit' },
                        { namePrefix: 'micro:bit' },
                        { services: [UART_SERVICE_UUID] }
                    ],
                    optionalServices: [UART_SERVICE_UUID]
                };
                
                addLog('üì° ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏Ç‡∏≠ permission...', 'info');
                bluetoothDevice = await navigator.bluetooth.requestDevice(options);
                
                addLog(`‚úÖ ‡∏û‡∏ö‡∏≠‡∏∏‡∏õ‡∏Å‡∏£‡∏ì‡πå: ${bluetoothDevice.name || 'Unknown Device'}`, 'success');
                
                // Listen for disconnection
                bluetoothDevice.addEventListener('gattserverdisconnected', onDisconnected);
                
                statusText.textContent = '‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠‡∏Å‡∏±‡∏ö‡∏≠‡∏∏‡∏õ‡∏Å‡∏£‡∏ì‡πå';
                addLog('üîå ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠ GATT server...', 'info');
                
                const server = await bluetoothDevice.gatt.connect();
                addLog('‚úÖ ‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠ GATT server ‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à', 'success');
                
                statusText.textContent = '‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠‡∏Å‡∏±‡∏ö UART service';
                addLog('üîß ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÄ‡∏Ç‡πâ‡∏≤‡∏ñ‡∏∂‡∏á UART service...', 'info');
                
                const service = await server.getPrimaryService(UART_SERVICE_UUID);
                addLog('‚úÖ ‡∏û‡∏ö UART service', 'success');
                
                // Get RX characteristic for notifications
                const rxCharacteristic = await service.getCharacteristic(UART_RX_CHARACTERISTIC_UUID);
                
                // Get TX characteristic for writing
                characteristic = await service.getCharacteristic(UART_TX_CHARACTERISTIC_UUID);
                
                addLog('‚úÖ ‡∏û‡∏ö characteristics', 'success');
                
                // ‡∏ü‡∏±‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏à‡∏≤‡∏Å micro:bit
                statusText.textContent = '‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤ notifications';
                await rxCharacteristic.startNotifications();
                rxCharacteristic.addEventListener('characteristicvaluechanged', handleRobotMessage);
                
                addLog('‚úÖ ‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤ notifications ‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à', 'success');
                
                isConnected = true;
                isConnecting = false;
                
                statusDiv.className = 'status connected';
                statusText.textContent = '‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠‡πÅ‡∏•‡πâ‡∏ß';
                connectBtn.textContent = '‡∏ï‡∏±‡∏î‡∏Å‡∏≤‡∏£‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠';
                connectBtn.className = 'connect-btn';
                connectBtn.disabled = false;
                emergencyBtn.disabled = false;
                
                addLog('üéâ ‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠‡∏Å‡∏±‡∏ö‡∏´‡∏∏‡πà‡∏ô‡∏¢‡∏ô‡∏ï‡πå‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à!', 'success');
                
                // ‡∏™‡πà‡∏á‡∏Ñ‡∏≥‡∏™‡∏±‡πà‡∏á‡∏ó‡∏î‡∏™‡∏≠‡∏ö
                setTimeout(() => {
                    sendToRobot('MOBILE_CONNECTED', 'Gateway Ready');
                    addLog('üì§ ‡∏™‡πà‡∏á‡∏™‡∏±‡∏ç‡∏ç‡∏≤‡∏ì‡∏ó‡∏î‡∏™‡∏≠‡∏ö', 'info');
                }, 1000);
                
                // ‡∏Ç‡∏≠ permission ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö notifications
                if ('Notification' in window && Notification.permission === 'default') {
                    const permission = await Notification.requestPermission();
                    addLog(`üîî Notification permission: ${permission}`, 'info');
                }
                
                // ‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏Å‡∏≤‡∏£‡∏ã‡∏¥‡∏á‡∏Ñ‡πå Google Calendar
                initGoogleCalendarSync();
                
            } catch (error) {
                isConnecting = false;
                console.error('‡∏Å‡∏≤‡∏£‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à:', error);
                
                let errorMessage = '‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à';
                
                if (error.name === 'NotFoundError') {
                    errorMessage = '‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏≠‡∏∏‡∏õ‡∏Å‡∏£‡∏ì‡πå micro:bit ‡∏ó‡∏µ‡πà‡πÄ‡∏Ç‡πâ‡∏≤‡∏Å‡∏±‡∏ô‡πÑ‡∏î‡πâ';
                } else if (error.name === 'SecurityError') {
                    errorMessage = '‡∏à‡∏≥‡πÄ‡∏õ‡πá‡∏ô‡∏ï‡πâ‡∏≠‡∏á‡πÉ‡∏ä‡πâ HTTPS ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö Bluetooth';
                } else if (error.name === 'NotSupportedError') {
                    errorMessage = 'Browser ‡πÑ‡∏°‡πà‡∏£‡∏≠‡∏á‡∏£‡∏±‡∏ö Web Bluetooth';
                } else if (error.name === 'NetworkError') {
                    errorMessage = '‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠‡∏Å‡∏±‡∏ö‡∏≠‡∏∏‡∏õ‡∏Å‡∏£‡∏ì‡πå‡πÑ‡∏î‡πâ';
                } else if (error.message.includes('User cancelled')) {
                    errorMessage = '‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å‡∏Å‡∏≤‡∏£‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠';
                }
                
                addLog(`‚ùå ${errorMessage}: ${error.message}`, 'error');
                
                const connectBtn = document.getElementById('connectBtn');
                const statusDiv = document.getElementById('connectionStatus');
                const statusText = document.getElementById('statusText');
                
                connectBtn.textContent = '‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠‡∏Å‡∏±‡∏ö‡∏´‡∏∏‡πà‡∏ô‡∏¢‡∏ô‡∏ï‡πå';
                connectBtn.className = 'connect-btn';
                connectBtn.disabled = false;
                statusDiv.className = 'status disconnected';
                statusText.textContent = '‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à';
            }
        }
        
        function onDisconnected(event) {
            addLog('‚ö†Ô∏è ‡∏≠‡∏∏‡∏õ‡∏Å‡∏£‡∏ì‡πå‡∏´‡∏•‡∏∏‡∏î‡∏Å‡∏≤‡∏£‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠', 'warning');
            disconnect();
        }
        
        function disconnect() {
            if (bluetoothDevice && bluetoothDevice.gatt.connected) {
                bluetoothDevice.gatt.disconnect();
            }
            
            isConnected = false;
            isConnecting = false;
            bluetoothDevice = null;
            characteristic = null;
            
            const statusDiv = document.getElementById('connectionStatus');
            const statusText = document.getElementById('statusText');
            const connectBtn = document.getElementById('connectBtn');
            const emergencyBtn = document.getElementById('emergencyBtn');
            
            statusDiv.className = 'status disconnected';
            statusText.textContent = '‡∏ï‡∏±‡∏î‡∏Å‡∏≤‡∏£‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠‡πÅ‡∏•‡πâ‡∏ß';
            connectBtn.textContent = '‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠‡∏Å‡∏±‡∏ö‡∏´‡∏∏‡πà‡∏ô‡∏¢‡∏ô‡∏ï‡πå';
            connectBtn.className = 'connect-btn';
            connectBtn.disabled = false;
            emergencyBtn.disabled = true;
            
            addLog('üîå ‡∏ï‡∏±‡∏î‡∏Å‡∏≤‡∏£‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠‡πÅ‡∏•‡πâ‡∏ß', 'info');
        }
        
        function handleRobotMessage(event) {
            const value = new TextDecoder().decode(event.target.value);
            console.log('‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡∏à‡∏≤‡∏Å‡∏´‡∏∏‡πà‡∏ô‡∏¢‡∏ô‡∏ï‡πå:', value);
            
            const cleanValue = value.trim();
            if (!cleanValue) return;
            
            addLog(`üì• ‡∏£‡∏±‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•: ${cleanValue}`, 'success');
            
            const parts = cleanValue.split(':');
            const command = parts[0];
            const data = parts.slice(1).join(':') || '';
            
            // ‡∏õ‡∏£‡∏∞‡∏°‡∏ß‡∏•‡∏ú‡∏•‡∏Ñ‡∏≥‡∏™‡∏±‡πà‡∏á‡∏à‡∏≤‡∏Å‡∏´‡∏∏‡πà‡∏ô‡∏¢‡∏ô‡∏ï‡πå
            switch(command) {
                case 'TILT_ALERT':
                    handleTiltAlert(data);
                    break;
                case 'EMERGENCY':
                case 'ADVANCED_EMERGENCY':
                    makeEmergencyCall(data);
                    break;
                case 'CALENDAR_SYNC':
                    syncCalendar();
                    break;
                case 'POMODORO':
                    handlePomodoroUpdate(data);
                    break;
                case 'WALKING_ALERT':
                    handleWalkingAlert(data);
                    break;
                case 'VOICE_DETECTED':
                    handleVoiceDetection();
                    break;
                case 'REMINDER':
                    showReminder(data);
                    break;
                case 'ACHIEVEMENT':
                    celebrateAchievement(data);
                    break;
                case 'BEHAVIOR_DATA':
                    updateUserStats(data);
                    break;
                case 'WEATHER_REQUEST':
                    sendWeatherData();
                    break;
                case 'BATTERY_LEVEL':
                    updateBatteryStatus(data);
                    break;
                case 'CRITICAL_BATTERY':
                    handleCriticalBattery();
                    break;
                case 'DAILY_REPORT':
                    processDailyReport(data);
                    break;
                case 'PING':
                    sendToRobot('PONG', 'Mobile Gateway Online');
                    break;
                default:
                    addLog(`üì® ‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°: ${cleanValue}`, 'info');
            }
        }
        
        function sendToRobot(command, data = '') {
            if (!characteristic) {
                addLog('‚ùå ‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠‡∏Å‡∏±‡∏ö‡∏≠‡∏∏‡∏õ‡∏Å‡∏£‡∏ì‡πå', 'error');
                return false;
            }
            
            try {
                const message = `${command}:${data}\n`;
                const encoder = new TextEncoder();
                const encodedMessage = encoder.encode(message);
                
                // Check if message is too long (micro:bit UART typically has 20 byte limit per packet)
                if (encodedMessage.length > 20) {
                    addLog(`‚ö†Ô∏è ‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡∏¢‡∏≤‡∏ß‡πÄ‡∏Å‡∏¥‡∏ô‡πÑ‡∏õ (${encodedMessage.length} bytes)`, 'warning');
                    // Split into chunks if needed
                    for (let i = 0; i < encodedMessage.length; i += 20) {
                        const chunk = encodedMessage.slice(i, i + 20);
                        characteristic.writeValue(chunk);
                    }
                } else {
                    characteristic.writeValue(encodedMessage);
                }
                
                addLog(`üì§ ‡∏™‡πà‡∏á: ${command}:${data}`, 'info');
                return true;
            } catch (error) {
                addLog(`‚ùå ‡∏™‡πà‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à: ${error.message}`, 'error');
                return false;
            }
        }
        
        function handleTiltAlert(data) {
            const coords = data.split(',');
            sendNotification('üö® ‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô‡∏ó‡πà‡∏≤‡∏ó‡∏≤‡∏á', `‡∏ï‡∏£‡∏ß‡∏à‡∏û‡∏ö‡∏ó‡πà‡∏≤‡∏ó‡∏≤‡∏á‡∏ú‡∏¥‡∏î‡∏õ‡∏Å‡∏ï‡∏¥ (X:${coords[0]}, Y:${coords[1]})`);
            sendLineNotify('‚ö†Ô∏è ‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô: ‡∏ï‡∏£‡∏ß‡∏à‡∏û‡∏ö‡∏Å‡∏≤‡∏£‡πÄ‡∏î‡∏¥‡∏ô‡πÄ‡∏≠‡∏µ‡∏¢‡∏á‡∏ú‡∏¥‡∏î‡∏õ‡∏Å‡∏ï‡∏¥');
            addLog('‚ö†Ô∏è ‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô‡∏ó‡πà‡∏≤‡∏ó‡∏≤‡∏á‡∏ú‡∏¥‡∏î‡∏õ‡∏Å‡∏ï‡∏¥', 'warning');
        }
        
        function handleWalkingAlert(data) {
            sendNotification('üëü ‡∏Å‡∏≤‡∏£‡πÄ‡∏î‡∏¥‡∏ô', '‡∏ï‡∏£‡∏ß‡∏à‡∏û‡∏ö‡∏Å‡∏≤‡∏£‡πÄ‡∏î‡∏¥‡∏ô‡πÑ‡∏°‡πà‡∏™‡∏°‡πà‡∏≥‡πÄ‡∏™‡∏°‡∏≠ ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏£‡∏∞‡∏ß‡∏±‡∏á');
            sendLineNotify('üëü ‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô: ‡∏Å‡∏≤‡∏£‡πÄ‡∏î‡∏¥‡∏ô‡πÑ‡∏°‡πà‡∏™‡∏°‡πà‡∏≥‡πÄ‡∏™‡∏°‡∏≠');
            addLog('‚ö†Ô∏è ‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô‡∏Å‡∏≤‡∏£‡πÄ‡∏î‡∏¥‡∏ô‡∏ú‡∏¥‡∏î‡∏õ‡∏Å‡∏ï‡∏¥', 'warning');
        }
        
        function handlePomodoroUpdate(data) {
            const parts = data.split(':');
            const status = parts[0];
            const time = parts[1];
            
            switch(status) {
                case 'START':
                    addLog(`‚è∞ ‡πÄ‡∏£‡∏¥‡πà‡∏° Pomodoro (${Math.floor(parseInt(time)/60)} ‡∏ô‡∏≤‡∏ó‡∏µ)`, 'info');
                    break;
                case 'RUNNING':
                    const remaining = Math.floor(parseInt(time)/60);
                    addLog(`‚è≥ Pomodoro ‡πÄ‡∏´‡∏•‡∏∑‡∏≠ ${remaining} ‡∏ô‡∏≤‡∏ó‡∏µ`, 'info');
                    break;
                case 'COMPLETED':
                    sendNotification('‚úÖ Pomodoro ‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à!', '‡∏ó‡∏≥‡∏á‡∏≤‡∏ô‡πÄ‡∏™‡∏£‡πá‡∏à‡πÅ‡∏•‡πâ‡∏ß ‡πÄ‡∏ß‡∏•‡∏≤‡∏û‡∏±‡∏Å‡∏ú‡πà‡∏≠‡∏ô');
                    addLog('üéâ Pomodoro ‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à!', 'success');
                    break;
                case 'BREAK_START':
                    addLog('‚òï ‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏û‡∏±‡∏Å‡∏ú‡πà‡∏≠‡∏ô', 'info');
                    break;
                case 'BREAK_END':
                    sendNotification('üí™ ‡∏û‡∏£‡πâ‡∏≠‡∏°‡∏ó‡∏≥‡∏á‡∏≤‡∏ô', '‡∏û‡∏±‡∏Å‡∏ú‡πà‡∏≠‡∏ô‡πÄ‡∏™‡∏£‡πá‡∏à‡πÅ‡∏•‡πâ‡∏ß ‡∏Å‡∏•‡∏±‡∏ö‡πÑ‡∏õ‡∏ó‡∏≥‡∏á‡∏≤‡∏ô‡∏Å‡∏±‡∏ô‡πÄ‡∏ñ‡∏≠‡∏∞!');
                    addLog('üí™ ‡∏à‡∏ö‡∏Å‡∏≤‡∏£‡∏û‡∏±‡∏Å‡∏ú‡πà‡∏≠‡∏ô', 'success');
                    break;
            }
        }
        
        function handleVoiceDetection() {
            addLog('üé§ ‡∏ï‡∏£‡∏ß‡∏à‡∏û‡∏ö‡πÄ‡∏™‡∏µ‡∏¢‡∏á‡∏î‡∏±‡∏á', 'info');
        }
        
        function showReminder(data) {
            sendNotification('üí° ‡∏Ñ‡∏≥‡πÅ‡∏ô‡∏∞‡∏ô‡∏≥', data);
            addLog(`üí° ‡πÅ‡∏™‡∏î‡∏á‡∏Ñ‡∏≥‡πÅ‡∏ô‡∏∞‡∏ô‡∏≥: ${data}`, 'info');
        }
        
        function celebrateAchievement(data) {
            sendNotification('üèÜ ‡∏Ñ‡∏ß‡∏≤‡∏°‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à‡πÉ‡∏´‡∏°‡πà!', data);
            addLog(`üèÜ ‡∏Ñ‡∏ß‡∏≤‡∏°‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à: ${data}`, 'success');
            // ‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÄ‡∏≠‡∏ü‡πÄ‡∏ü‡∏Ñ celebration
            document.body.style.background = 'linear-gradient(45deg, #ff6b6b, #4ecdc4, #45b7d1, #96ceb4)';
            setTimeout(() => {
                document.body.style.background = 'linear-gradient(135deg, #667eea 0%, #764ba2 100%)';
            }, 3000);
        }
        
        function updateUserStats(data) {
            const stats = data.split(',');
            addLog(`üìä ‡∏™‡∏ñ‡∏¥‡∏ï‡∏¥ - Pomodoro: ${stats[0]}, Break: ${stats[1]}, ‡∏Ñ‡∏≥‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô: ${stats[2]}`, 'info');
        }
        
        function sendWeatherData() {
            // ‡πÉ‡∏ä‡πâ Weather API (‡∏ï‡∏±‡∏ß‡∏≠‡∏¢‡πà‡∏≤‡∏á)
            fetch('https://api.openweathermap.org/data/2.5/weather?q=Bangkok&appid=YOUR_API_KEY')
                .then(response => response.json())
                .then(data => {
                    const temp = Math.round(data.main.temp - 273.15);
                    const humidity = data.main.humidity;
                    const condition = data.weather[0].main.toLowerCase();
                    
                    const weatherData = `${temp},${humidity},${condition}`;
                    sendToRobot('WEATHER_DATA', weatherData);
                })
                .catch(error => {
                    console.error('Weather API error:', error);
                    // ‡∏™‡πà‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏à‡∏≥‡∏•‡∏≠‡∏á
                    sendToRobot('WEATHER_DATA', '25,60,sunny');
                });
        }
        
        function updateBatteryStatus(level) {
            const batteryPercent = parseInt(level);
            addLog(`üîã ‡πÅ‡∏ö‡∏ï‡πÄ‡∏ï‡∏≠‡∏£‡∏µ‡πà: ${batteryPercent}%`, 'info');
            
            if (batteryPercent <= 20) {
                sendNotification('üîã ‡πÅ‡∏ö‡∏ï‡πÄ‡∏ï‡∏≠‡∏£‡∏µ‡πà‡∏ï‡πà‡∏≥', `‡πÅ‡∏ö‡∏ï‡πÄ‡∏ï‡∏≠‡∏£‡∏µ‡πà‡πÄ‡∏´‡∏•‡∏∑‡∏≠ ${batteryPercent}%`);
            }
        }
        
        function handleCriticalBattery() {
            sendNotification('üîã ‡πÅ‡∏ö‡∏ï‡πÄ‡∏ï‡∏≠‡∏£‡∏µ‡πà‡∏´‡∏°‡∏î!', '‡∏´‡∏∏‡πà‡∏ô‡∏¢‡∏ô‡∏ï‡πå‡∏à‡∏∞‡∏õ‡∏¥‡∏î‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡πÄ‡∏£‡πá‡∏ß‡πÜ ‡∏ô‡∏µ‡πâ');
            sendLineNotify('üîã ‡∏â‡∏∏‡∏Å‡πÄ‡∏â‡∏¥‡∏ô: ‡πÅ‡∏ö‡∏ï‡πÄ‡∏ï‡∏≠‡∏£‡∏µ‡πà‡∏´‡∏∏‡πà‡∏ô‡∏¢‡∏ô‡∏ï‡πå‡∏´‡∏°‡∏î‡πÅ‡∏•‡πâ‡∏ß!');
            addLog('üîã ‡πÅ‡∏ö‡∏ï‡πÄ‡∏ï‡∏≠‡∏£‡∏µ‡πà‡πÉ‡∏Å‡∏•‡πâ‡∏´‡∏°‡∏î - ‡∏ï‡πâ‡∏≠‡∏á‡∏ä‡∏≤‡∏£‡πå‡∏à‡∏î‡πà‡∏ß‡∏ô!', 'error');
        }
        
        function processDailyReport(data) {
            try {
                const report = JSON.parse(data);
                addLog(`üìä ‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô‡∏õ‡∏£‡∏∞‡∏à‡∏≥‡∏ß‡∏±‡∏ô - Pomodoro: ${report.totalPomodoroTime/60}min, ‡∏Ñ‡∏≥‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô: ${report.tiltWarningCount}`, 'info');
                sendLineNotify(`üìä ‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô‡∏õ‡∏£‡∏∞‡∏à‡∏≥‡∏ß‡∏±‡∏ô:\n- ‡πÄ‡∏ß‡∏•‡∏≤‡∏ó‡∏≥‡∏á‡∏≤‡∏ô: ${Math.floor(report.totalPomodoroTime/60)} ‡∏ô‡∏≤‡∏ó‡∏µ\n- ‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏Ñ‡∏≥‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô: ${report.tiltWarningCount}`);
            } catch (error) {
                addLog('üìä ‡πÑ‡∏î‡πâ‡∏£‡∏±‡∏ö‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô‡∏õ‡∏£‡∏∞‡∏à‡∏≥‡∏ß‡∏±‡∏ô', 'info');
            }
        }
        
        async function makeEmergencyCall() {
            try {
                // ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö Android: ‡πÉ‡∏ä‡πâ intent
                if (/Android/i.test(navigator.userAgent)) {
                    window.location.href = 'tel:1669';
                } else {
                    // ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö iOS ‡∏´‡∏£‡∏∑‡∏≠ browser ‡∏≠‡∏∑‡πà‡∏ô‡πÜ
                    window.open('tel:1669', '_self');
                }
                
                // ‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô‡∏Ñ‡∏£‡∏≠‡∏ö‡∏Ñ‡∏£‡∏±‡∏ß
                sendNotification('üö® ‡∏Å‡∏≤‡∏£‡πÇ‡∏ó‡∏£‡∏â‡∏∏‡∏Å‡πÄ‡∏â‡∏¥‡∏ô', '‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏ó‡∏£‡πÑ‡∏õ‡πÄ‡∏ö‡∏≠‡∏£‡πå‡∏â‡∏∏‡∏Å‡πÄ‡∏â‡∏¥‡∏ô 1669');
                sendLineNotify('üö® ‡∏â‡∏∏‡∏Å‡πÄ‡∏â‡∏¥‡∏ô: ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏ó‡∏£‡πÑ‡∏õ‡πÄ‡∏ö‡∏≠‡∏£‡πå 1669');
                
                addLog('üìû ‡πÇ‡∏ó‡∏£‡πÑ‡∏õ‡πÄ‡∏ö‡∏≠‡∏£‡πå‡∏â‡∏∏‡∏Å‡πÄ‡∏â‡∏¥‡∏ô 1669', 'warning');
                
            } catch (error) {
                console.error('‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÇ‡∏ó‡∏£‡πÑ‡∏î‡πâ:', error);
                addLog('‚ùå ‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÇ‡∏ó‡∏£‡πÑ‡∏î‡πâ: ' + error.message, 'error');
            }
        }
        
        function sendNotification(title, body) {
            if ('Notification' in window && Notification.permission === 'granted') {
                const notification = new Notification(title, {
                    body: body,
                    icon: 'ü§ñ',
                    vibrate: [200, 100, 200],
                    tag: 'robot-assistant'
                });
                
                // Auto close after 5 seconds
                setTimeout(() => notification.close(), 5000);
            } else if ('Notification' in window && Notification.permission === 'default') {
                addLog('üîî ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏≠‡∏ô‡∏∏‡∏ç‡∏≤‡∏ï notifications', 'warning');
            }
        }
        
        function sendLineNotify(message) {
            // ‡∏ï‡∏±‡∏ß‡∏≠‡∏¢‡πà‡∏≤‡∏á‡∏Å‡∏≤‡∏£‡πÉ‡∏ä‡πâ LINE Notify - ‡∏ï‡πâ‡∏≠‡∏á‡πÅ‡∏ó‡∏ô‡∏ó‡∏µ‡πà‡∏î‡πâ‡∏ß‡∏¢ token ‡∏à‡∏£‡∏¥‡∏á
            const LINE_TOKEN = 'YOUR_LINE_NOTIFY_TOKEN_HERE';
            
            if (LINE_TOKEN === 'YOUR_LINE_NOTIFY_TOKEN_HERE') {
                addLog('‚ö†Ô∏è ‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤ LINE Notify token', 'warning');
                return;
            }
            
            fetch('https://notify-api.line.me/api/notify', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/x-www-form-urlencoded',
                    'Authorization': `Bearer ${LINE_TOKEN}`
                },
                body: `message=${encodeURIComponent(message)}`
            })
            .then(response => {
                if (response.ok) {
                    addLog('‚úÖ ‡∏™‡πà‡∏á LINE Notify ‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à', 'success');
                } else {
                    addLog('‚ùå ‡∏™‡πà‡∏á LINE Notify ‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à', 'error');
                }
            })
            .catch(error => {
                console.error('LINE Notify error:', error);
                addLog('‚ùå ‡∏™‡πà‡∏á LINE Notify ‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à: ' + error.message, 'error');
            });
        }
        
        function initGoogleCalendarSync() {
            // Google Calendar API integration
            addLog('üìÖ ‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏Å‡∏≤‡∏£‡∏ã‡∏¥‡∏á‡∏Ñ‡πå Google Calendar', 'info');
            
            // ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö demo - ‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô‡∏à‡∏£‡∏¥‡∏á‡∏ï‡πâ‡∏≠‡∏á‡πÉ‡∏ä‡πâ Google Calendar API
            setTimeout(() => {
                addLog('‚úÖ ‡∏ã‡∏¥‡∏á‡∏Ñ‡πå Google Calendar ‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à', 'success');
            }, 2000);
        }
        
        function syncCalendar() {
            // ‡∏ã‡∏¥‡∏á‡∏Ñ‡πå‡∏Å‡∏≥‡∏´‡∏ô‡∏î‡∏Å‡∏≤‡∏£
            addLog('üîÑ ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ã‡∏¥‡∏á‡∏Ñ‡πå‡∏Å‡∏≥‡∏´‡∏ô‡∏î‡∏Å‡∏≤‡∏£‡πÉ‡∏´‡∏°‡πà...', 'info');
            
            setTimeout(() => {
                addLog('‚úÖ ‡∏ã‡∏¥‡∏á‡∏Ñ‡πå‡∏Å‡∏≥‡∏´‡∏ô‡∏î‡∏Å‡∏≤‡∏£‡πÄ‡∏™‡∏£‡πá‡∏à‡∏™‡∏¥‡πâ‡∏ô', 'success');
            }, 1500);
        }
        
        // Test functions for debugging
        function testConnection() {
            if (isConnected && characteristic) {
                sendToRobot('TEST', 'Mobile test message');
                addLog('üß™ ‡∏™‡πà‡∏á‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡∏ó‡∏î‡∏™‡∏≠‡∏ö', 'info');
            } else {
                addLog('‚ùå ‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠', 'error');
            }
        }
        
        // Add test button (hidden by default)
        function addTestButton() {
            if (window.location.hash === '#debug') {
                const testBtn = document.createElement('button');
                testBtn.textContent = 'üß™ ‡∏ó‡∏î‡∏™‡∏≠‡∏ö‡∏Å‡∏≤‡∏£‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠';
                testBtn.className = 'connect-btn';
                testBtn.style.marginTop = '10px';
                testBtn.style.background = 'linear-gradient(45deg, #9C27B0, #673AB7)';
                testBtn.onclick = testConnection;
                
                document.querySelector('.container').appendChild(testBtn);
                addLog('üîß ‡πÇ‡∏´‡∏°‡∏î Debug ‡πÄ‡∏õ‡∏¥‡∏î‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô', 'info');
            }
        }
        
        // Initialize when page loads
        document.addEventListener('DOMContentLoaded', function() {
            initDebugInfo();
            addTestButton();
            
            // Request notification permission on page load
            if ('Notification' in window && Notification.permission === 'default') {
                setTimeout(() => {
                    Notification.requestPermission().then(permission => {
                        addLog(`üîî Notification permission: ${permission}`, 'info');
                    });
                }, 2000);
            }
            
            addLog('üöÄ ‡∏£‡∏∞‡∏ö‡∏ö‡∏û‡∏£‡πâ‡∏≠‡∏°‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô', 'success');
        });
        
        // Handle page visibility change
        document.addEventListener('visibilitychange', function() {
            if (document.hidden && isConnected) {
                addLog('üì± ‡πÅ‡∏≠‡∏õ‡∏ó‡∏≥‡∏á‡∏≤‡∏ô‡πÉ‡∏ô‡πÄ‡∏ö‡∏∑‡πâ‡∏≠‡∏á‡∏´‡∏•‡∏±‡∏á', 'info');
            } else if (!document.hidden && isConnected) {
                addLog('üì± ‡∏Å‡∏•‡∏±‡∏ö‡πÄ‡∏Ç‡πâ‡∏≤‡πÅ‡∏≠‡∏õ', 'info');
                // Send ping to check connection
                setTimeout(() => {
                    sendToRobot('PING', 'Mobile back online');
                }, 500);
            }
        });
        
        // Handle before unload
        window.addEventListener('beforeunload', function() {
            if (isConnected) {
                sendToRobot('MOBILE_DISCONNECT', 'Gateway closing');
                disconnect();
            }
        });
        
        // Add keyboard shortcuts for debugging
        document.addEventListener('keydown', function(event) {
            if (event.altKey && event.key === 't') {
                testConnection();
            } else if (event.altKey && event.key === 'd') {
                const debugInfo = document.getElementById('debugInfo');
                debugInfo.style.display = debugInfo.style.display === 'none' ? 'block' : 'none';
            }
        });
        
    </script>
</body>
</html>